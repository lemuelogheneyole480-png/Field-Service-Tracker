<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ministry Report Book - Jehovah's Witnesses</title>
     <link rel="manifest" href="manifest.json">
     <meta name="theme-color" content="#4A90E2">
     
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0057a3">
    <meta name="description" content="Track and manage your ministry activity - For Jehovah's Witnesses">
    
    <!-- Apple PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ministry Report Book">
    
    <!-- Microsoft PWA Support -->
    <meta name="msapplication-TileColor" content="#0057a3">
    
    <!-- Manifest for PWA -->
    <link rel="manifest" id="appManifest">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet CSS & JS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet.draw for drawing tools -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <!-- Leaflet Geocoder for address search -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <!-- Leaflet Fullscreen -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/2.0.0/Control.FullScreen.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/2.0.0/Control.FullScreen.js"></script>
    <!-- Leaflet Measure -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-measure@3.1.0/dist/leaflet-measure.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet-measure@3.1.0/dist/leaflet-measure.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #333;
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }

        body.dark-mode {
            background: #121212;
            color: #ffffff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* ===== SPLASH SCREEN REMOVED ===== */

        /* ===== AUTHENTICATION PAGES ===== */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        .auth-container::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
            animation: float 20s linear infinite;
            opacity: 0.3;
        }

        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(-50px, -50px) rotate(360deg); }
        }

        .auth-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
            animation: slideUp 0.6s ease-out;
        }

        .dark-mode .auth-box {
            background: rgba(30, 30, 30, 0.95);
            color: #ffffff;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            color: #0057a3;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .dark-mode .auth-header h1 {
            color: #4dabf7;
        }

        .auth-header p {
            color: #666;
            font-size: 0.95rem;
        }

        .dark-mode .auth-header p {
            color: #cccccc;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
        }

        .dark-mode .auth-tabs {
            border-bottom-color: #404040;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .dark-mode .auth-tab {
            color: #cccccc;
        }

        .auth-tab.active {
            color: #0057a3;
            border-bottom-color: #0057a3;
        }

        .dark-mode .auth-tab.active {
            color: #4dabf7;
            border-bottom-color: #4dabf7;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ===== BOTTOM NAVIGATION FOR MOBILE ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }

        .dark-mode .bottom-nav {
            background: #2d2d2d;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #666;
            padding: 5px;
            flex: 1;
            transition: all 0.3s;
        }

        .dark-mode .bottom-nav-item {
            color: #cccccc;
        }

        .bottom-nav-item.active {
            color: #0057a3;
            transform: translateY(-5px);
        }

        .dark-mode .bottom-nav-item.active {
            color: #4dabf7;
        }

        .bottom-nav-item i {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .bottom-nav-item span {
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* ===== APP CONTAINER ===== */
        .app-container {
            display: none;
            min-height: 100vh;
        }

        .app-container.active {
            display: block;
        }

        /* ===== HEADER ===== */
        header {
            background: linear-gradient(135deg, #0057a3 0%, #004a8c 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 87, 163, 0.3);
            position: relative;
            overflow: hidden;
        }

        .dark-mode header {
            background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23007bff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.3;
            animation: subtleFloat 20s linear infinite;
        }

        @keyframes subtleFloat {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-50px, -50px); }
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            position: relative;
            z-index: 1;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .user-menu {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            backdrop-filter: blur(5px);
        }

        .logout-btn {
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logout-btn:hover {
            background: rgba(200, 35, 51, 0.9);
            transform: scale(1.05);
        }

        /* ===== NAV TABS ===== */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            margin: 25px 0;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .dark-mode .nav-tabs {
            background: #2d2d2d;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .nav-tabs::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #0057a3, #28a745, #ffc107, #dc3545);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .tab {
            flex: 1;
            padding: 18px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .dark-mode .tab {
            color: #cccccc;
        }

        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 87, 163, 0.1), transparent);
            transition: left 0.5s;
        }

        .dark-mode .tab::before {
            background: linear-gradient(90deg, transparent, rgba(77, 171, 247, 0.1), transparent);
        }

        .tab:hover::before {
            left: 100%;
        }

        .tab:hover {
            background: #f8f9fa;
            color: #0057a3;
        }

        .dark-mode .tab:hover {
            background: #404040;
            color: #4dabf7;
        }

        .tab.active {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #0057a3;
            border-bottom: 3px solid #0057a3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 87, 163, 0.2);
        }

        .dark-mode .tab.active {
            background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
            color: white;
            border-bottom-color: #4dabf7;
        }

        /* ===== PAGES ===== */
        .page {
            display: none;
            animation: fadeIn 0.5s ease-out;
            padding-bottom: 80px;
        }

        .page.active {
            display: block;
        }

        /* ===== SCRIPTURE SECTION ===== */
        .scripture {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            border-left: 5px solid #4caf50;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.15);
            position: relative;
            overflow: hidden;
        }

        .dark-mode .scripture {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            color: white;
        }

        .scripture::before {
            content: '‚ùù';
            position: absolute;
            top: -20px;
            left: 10px;
            font-size: 80px;
            color: rgba(76, 175, 80, 0.1);
            font-family: serif;
        }

        .dark-mode .scripture::before {
            color: rgba(76, 175, 80, 0.2);
        }

        .scripture p {
            font-size: 1.2rem;
            color: #2e7d32;
            font-style: italic;
            text-align: center;
            margin: 0;
            position: relative;
            z-index: 1;
        }

        .dark-mode .scripture p {
            color: #a5d6a7;
        }

        .scripture i {
            color: #4caf50;
            margin-right: 10px;
        }

        /* ===== DASHBOARD LAYOUT ===== */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin: 25px 0;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .dark-mode .card {
            background: #2d2d2d;
            color: white;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #0057a3, #28a745);
        }

        .card:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12);
        }

        .dark-mode .card:hover {
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.3);
        }

        .card h2 {
            color: #0057a3;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .dark-mode .card h2 {
            color: #4dabf7;
        }

        .card h2::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 50px;
            height: 3px;
            background: #0057a3;
            border-radius: 2px;
        }

        .dark-mode .card h2::after {
            background: #4dabf7;
        }

        /* ===== STATS ===== */
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .dark-mode .stat-box {
            background: linear-gradient(135deg, #404040 0%, #303030 100%);
        }

        .stat-box:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            transform: scale(1.05);
            border-color: #0057a3;
        }

        .dark-mode .stat-box:hover {
            background: linear-gradient(135deg, #505050 0%, #404040 100%);
            border-color: #4dabf7;
        }

        .stat-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(0, 87, 163, 0.1) 50%, transparent 70%);
            animation: shimmer 2s infinite;
        }

        .dark-mode .stat-box::before {
            background: linear-gradient(45deg, transparent 30%, rgba(77, 171, 247, 0.1) 50%, transparent 70%);
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #0057a3;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
        }

        .dark-mode .stat-value {
            color: #4dabf7;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .dark-mode .stat-label {
            color: #cccccc;
        }

        /* ===== FORM STYLES ===== */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .dark-mode label {
            color: #cccccc;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
            background: white;
            color: #333;
        }

        .dark-mode input,
        .dark-mode select,
        .dark-mode textarea {
            background: #404040;
            color: white;
            border-color: #505050;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #0057a3;
            box-shadow: 0 0 0 0.2rem rgba(0, 87, 163, 0.25);
            transform: translateY(-2px);
        }

        .dark-mode input:focus,
        .dark-mode select:focus,
        .dark-mode textarea:focus {
            border-color: #4dabf7;
            box-shadow: 0 0 0 0.2rem rgba(77, 171, 247, 0.25);
        }

        /* ===== BUTTONS ===== */
        .btn {
            background: linear-gradient(135deg, #0057a3 0%, #004a8c 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 87, 163, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
        }

        /* ===== YEARLY GRID ===== */
        .yearly-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .month-cell {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .dark-mode .month-cell {
            background: #404040;
            color: white;
        }

        .month-cell::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(0, 87, 163, 0.05) 50%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .dark-mode .month-cell::before {
            background: linear-gradient(45deg, transparent 30%, rgba(77, 171, 247, 0.1) 50%, transparent 70%);
        }

        .month-cell:hover::before {
            opacity: 1;
        }

        .month-cell:hover {
            background: #e9ecef;
            border-color: #0057a3;
            transform: translateY(-3px);
        }

        .dark-mode .month-cell:hover {
            background: #505050;
            border-color: #4dabf7;
        }

        .month-cell.active {
            background: #0057a3;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 87, 163, 0.3);
        }

        .dark-mode .month-cell.active {
            background: #4dabf7;
        }

        /* ===== REMINDERS ===== */
        .reminder-item {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideInRight 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }

        .dark-mode .reminder-item {
            background: #424242;
            border-left-color: #ffb300;
        }

        .reminder-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #ffc107, transparent);
        }

        .dark-mode .reminder-item::before {
            background: linear-gradient(90deg, #ffb300, transparent);
        }

        .reminder-item.urgent {
            background: #ffe6e6;
            border-left-color: #dc3545;
        }

        .dark-mode .reminder-item.urgent {
            background: #5c2b2b;
            border-left-color: #ff5252;
        }

        .reminder-item.urgent::before {
            background: linear-gradient(90deg, #dc3545, transparent);
        }

        .dark-mode .reminder-item.urgent::before {
            background: linear-gradient(90deg, #ff5252, transparent);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
            position: relative;
        }

        .dark-mode .empty-state {
            color: #999999;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #28a745;
            animation: pulse 2s infinite;
        }

        /* ===== PROGRESS BAR ===== */
        .progress-container {
            margin: 20px 0;
            position: relative;
        }

        .progress-label {
            margin-bottom: 10px;
            font-weight: 600;
            color: #495057;
        }

        .dark-mode .progress-label {
            color: #cccccc;
        }

        .progress-bar {
            height: 25px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .progress-bar {
            background: #404040;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #7be495 100%);
            border-radius: 12px;
            transition: width 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.2) 50%, transparent 70%);
            animation: shimmer 2s infinite;
        }

        .progress-text {
            text-align: center;
            margin-top: 8px;
            font-weight: 600;
            color: #0057a3;
        }

        .dark-mode .progress-text {
            color: #4dabf7;
        }

        /* ===== MODAL STYLES ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        .dark-mode .modal-content {
            background: #2d2d2d;
            color: white;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .dark-mode .modal-header {
            border-bottom-color: #404040;
        }

        .modal-header h3 {
            color: #0057a3;
            margin: 0;
        }

        .dark-mode .modal-header h3 {
            color: #4dabf7;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #6c757d;
            transition: color 0.3s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-modal:hover {
            background: #f8f9fa;
            color: #dc3545;
        }

        .dark-mode .close-modal:hover {
            background: #404040;
        }

        /* ===== NOTIFICATION ===== */
        .notification {
            display: none;
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            animation: slideInDown 0.5s ease-out;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .notification.success {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.9) 0%, rgba(33, 136, 56, 0.9) 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.9) 0%, rgba(200, 35, 51, 0.9) 100%);
        }

        .notification.info {
            background: linear-gradient(135deg, rgba(23, 162, 184, 0.9) 0%, rgba(19, 132, 150, 0.9) 100%);
        }

        .notification.warning {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.9) 0%, rgba(224, 168, 0, 0.9) 100%);
            color: #212529;
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            bottom: 80px;
            left: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: rgba(40, 167, 69, 0.9);
        }

        .toast.error {
            background: rgba(220, 53, 69, 0.9);
        }

        .toast.info {
            background: rgba(23, 162, 184, 0.9);
        }

        .toast.warning {
            background: rgba(255, 193, 7, 0.9);
            color: #212529;
        }

        /* ===== FOOTER ===== */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, #343a40 0%, #212529 100%);
            color: white;
            text-align: center;
            padding: 15px;
            font-size: 0.9rem;
            z-index: 100;
            border-top: 3px solid #0057a3;
        }

        .dark-mode footer {
            background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
            border-top-color: #4dabf7;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes slideInDown {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ===== BIBLE STUDIES GRID ===== */
        .bible-studies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .dark-mode .bible-studies-grid {
            background: #404040;
            border-color: #505050;
        }

        .study-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .study-checkbox:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .dark-mode .study-checkbox:hover {
            background: #505050;
        }

        .study-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .study-checkbox label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }

        /* ===== TIMER SECTION ===== */
        .timer-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
        }

        .dark-mode .timer-section {
            background: linear-gradient(135deg, #404040 0%, #303030 100%);
            border-color: #505050;
        }

        .timer-display {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            color: #0057a3;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #0057a3;
            box-shadow: 0 4px 15px rgba(0, 87, 163, 0.1);
        }

        .dark-mode .timer-display {
            background: #303030;
            color: #4dabf7;
            border-color: #4dabf7;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* ===== MAP STYLES ===== */
        .map-container {
            height: 400px;
            background: linear-gradient(135deg, #f0f8ff 0%, #e1f0ff 100%);
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #c2e0ff;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 87, 163, 0.1);
        }

        .dark-mode .map-container {
            background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
            border-color: #4dabf7;
        }
        
        #studyMap {
            width: 100%;
            height: 100%;
            border-radius: 10px;
        }
        
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .map-btn {
            background: linear-gradient(135deg, #0057a3 0%, #004a8c 100%);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .map-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 87, 163, 0.3);
        }

        /* ===== MAP TOOLBAR ===== */
        .map-toolbar {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .map-tool {
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .dark-mode .map-tool {
            background: #404040;
            color: white;
        }
        
        .map-tool:hover {
            transform: scale(1.1);
            background: #f8f9fa;
        }

        .dark-mode .map-tool:hover {
            background: #505050;
        }
        
        .map-tool.active {
            background: #0057a3;
            color: white;
        }

        .dark-mode .map-tool.active {
            background: #4dabf7;
        }

        /* ===== PIONEER GOAL CALCULATOR ===== */
        .goal-calculator {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #4caf50;
        }

        .dark-mode .goal-calculator {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            border-color: #4caf50;
        }

        .calculator-result {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #0057a3;
            animation: slideInUp 0.5s ease-out;
        }

        .dark-mode .calculator-result {
            background: #404040;
            border-left-color: #4dabf7;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .dark-mode .result-item {
            border-bottom-color: #505050;
        }

        .result-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        /* ===== PWA INSTALL BUTTON ===== */
        .pwa-install-btn {
            position: fixed;
            bottom: 100px;
            right: 25px;
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            z-index: 99;
            animation: slideInUp 0.5s ease-out;
        }
        
        .pwa-install-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }
        
        .pwa-install-btn.hidden {
            display: none;
        }
        
        /* ===== OFFLINE STATUS ===== */
        .offline-status {
            position: fixed;
            top: 25px;
            left: 25px;
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            border-left: 4px solid #856404;
            animation: slideInLeft 0.3s ease-out;
            backdrop-filter: blur(10px);
        }
        
        .offline-status.hidden {
            display: none;
        }

        /* ===== SYNC STATUS ===== */
        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 1001;
            backdrop-filter: blur(10px);
        }

        .sync-status.syncing {
            background: rgba(255, 193, 7, 0.9);
            color: #212529;
        }

        .sync-status.error {
            background: rgba(220, 53, 69, 0.9);
        }

        /* ===== UPDATE NOTIFICATION ===== */
        .update-notification {
            position: fixed;
            bottom: 100px;
            left: 20px;
            right: 20px;
            background: #0057a3;
            color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 87, 163, 0.3);
            z-index: 1000;
            display: none;
            animation: slideInUp 0.3s ease-out;
        }

        .update-notification.show {
            display: block;
        }

        /* ===== SWIPE ACTIONS ===== */
        .swipe-item {
            position: relative;
            overflow: hidden;
        }

        .swipe-actions {
            position: absolute;
            top: 0;
            right: -200px;
            bottom: 0;
            display: flex;
            transition: right 0.3s ease;
        }

        .swipe-item.swiping .swipe-actions {
            right: 0;
        }

        .swipe-action {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
            color: white;
            min-width: 80px;
        }

        .swipe-action.edit {
            background: #ffc107;
        }

        .swipe-action.delete {
            background: #dc3545;
        }

        .swipe-action.complete {
            background: #28a745;
        }

        /* ===== PULL TO REFRESH ===== */
        .pull-to-refresh {
            position: relative;
            overflow: hidden;
        }

        .refresh-indicator {
            position: absolute;
            top: -60px;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            transition: top 0.3s;
        }

        .dark-mode .refresh-indicator {
            background: #404040;
        }

        .refresh-indicator.active {
            top: 0;
        }

        .refresh-indicator i {
            font-size: 1.5rem;
            color: #0057a3;
            animation: spin 1s linear infinite;
        }

        /* ===== NOTIFICATION BADGE ===== */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* ===== BIOMETRIC BUTTON ===== */
        .biometric-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #0057a3 0%, #004a8c 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .biometric-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 87, 163, 0.3);
        }

        /* ===== DARK MODE TOGGLE ===== */
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }

        .dark-mode-toggle:hover {
            transform: scale(1.1);
        }

        /* ===== LOADING SPINNER ===== */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0057a3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .spinner.small {
            width: 20px;
            height: 20px;
            border-width: 2px;
        }

        .spinner.hidden {
            display: none;
        }

        /* ===== STORAGE METER ===== */
        .storage-meter {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .dark-mode .storage-meter {
            background: #404040;
        }

        .storage-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #0057a3);
            transition: width 0.3s;
        }

        /* ===== ENHANCED SIGNUP FEATURES ===== */
        .password-strength {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .dark-mode .password-strength {
            background: #404040;
        }

        .password-strength.active {
            display: block;
            animation: slideInDown 0.3s ease-out;
        }

        .strength-meter {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }

        .dark-mode .strength-meter {
            background: #505050;
        }

        .strength-fill {
            height: 100%;
            width: 0%;
            border-radius: 4px;
            transition: width 0.3s, background-color 0.3s;
        }

        .strength-text {
            font-size: 0.85rem;
            color: #666;
            text-align: center;
        }

        .dark-mode .strength-text {
            color: #cccccc;
        }

        .congregation-search {
            position: relative;
            margin-bottom: 10px;
        }

        .congregation-search-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #0057a3;
            cursor: pointer;
            padding: 5px;
        }

        .dark-mode .congregation-search-btn {
            color: #4dabf7;
        }

        .congregation-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .dark-mode .congregation-suggestions {
            background: #2d2d2d;
            border-color: #404040;
        }

        .congregation-suggestions.active {
            display: block;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .dark-mode .suggestion-item {
            color: white;
        }

        .suggestion-item:hover {
            background: #f8f9fa;
        }

        .dark-mode .suggestion-item:hover {
            background: #404040;
        }

        .ministry-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }

        .ministry-type-option {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .dark-mode .ministry-type-option {
            background: #404040;
            border-color: #505050;
            color: white;
        }

        .ministry-type-option:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .dark-mode .ministry-type-option:hover {
            background: #505050;
        }

        .ministry-type-option.selected {
            background: #e3f2fd;
            border-color: #0057a3;
            color: #0057a3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 87, 163, 0.2);
        }

        .dark-mode .ministry-type-option.selected {
            background: #1a237e;
            border-color: #4dabf7;
            color: #4dabf7;
        }

        .terms-agreement {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }

        .dark-mode .terms-agreement {
            background: #404040;
            border-color: #505050;
            color: white;
        }

        .signup-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .signup-steps::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e9ecef;
            z-index: 1;
        }

        .dark-mode .signup-steps::before {
            background: #404040;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            cursor: pointer;
        }

        .step-number {
            width: 30px;
            height: 30px;
            background: #e9ecef;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
            transition: all 0.3s;
        }

        .dark-mode .step-number {
            background: #404040;
            color: white;
        }

        .step.active .step-number {
            background: #0057a3;
            color: white;
            transform: scale(1.1);
        }

        .dark-mode .step.active .step-number {
            background: #4dabf7;
        }

        .step.completed .step-number {
            background: #28a745;
            color: white;
        }

        .step-label {
            font-size: 0.8rem;
            color: #666;
            text-align: center;
        }

        .dark-mode .step-label {
            color: #cccccc;
        }

        .step.active .step-label {
            color: #0057a3;
            font-weight: 600;
        }

        .dark-mode .step.active .step-label {
            color: #4dabf7;
        }

        .password-input-group {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 5px;
        }

        .dark-mode .password-toggle {
            color: #cccccc;
        }

        .password-criteria {
            list-style: none;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        .dark-mode .password-criteria {
            background: #404040;
            color: white;
        }

        .password-criteria li {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .criteria-met {
            color: #28a745;
        }

        .criteria-unmet {
            color: #dc3545;
        }

        .profile-picture-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }

        .profile-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 15px;
            border: 3px solid #0057a3;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .dark-mode .profile-preview {
            background: #404040;
            border-color: #4dabf7;
        }

        .profile-preview:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 87, 163, 0.3);
        }

        .dark-mode .profile-preview:hover {
            box-shadow: 0 4px 12px rgba(77, 171, 247, 0.3);
        }

        .profile-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-btn {
            background: linear-gradient(135deg, #0057a3 0%, #004a8c 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 87, 163, 0.3);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .signup-step {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
        }

        .signup-step.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
                display: none;
            }
            
            .bottom-nav {
                display: flex;
            }
            
            .tab {
                padding: 15px;
            }
            
            .timer-controls {
                flex-direction: column;
            }
            
            .pwa-install-btn {
                bottom: 80px;
                right: 15px;
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .auth-box {
                padding: 20px;
                margin: 20px;
                max-width: 90%;
            }
            
            .user-menu {
                position: relative;
                top: 0;
                right: 0;
                justify-content: center;
                margin-top: 10px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .ministry-type-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .step-navigation {
                flex-direction: column;
                gap: 10px;
            }
            
            .step-navigation button {
                width: 100%;
            }

            .dark-mode-toggle {
                top: 10px;
                left: 10px;
            }

            .sync-status {
                top: 10px;
                right: 10px;
                font-size: 0.7rem;
            }
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: 1.8rem;
            }
            
            .card {
                padding: 15px;
            }
            
            .timer-display {
                font-size: 2rem;
            }
            
            .auth-box {
                padding: 15px;
            }
            
            .ministry-type-grid {
                grid-template-columns: 1fr;
            }
            
            .signup-steps {
                flex-direction: column;
                gap: 15px;
            }
            
            .signup-steps::before {
                display: none;
            }
            
            .step {
                flex-direction: row;
                gap: 10px;
            }
            
            .step-label {
                text-align: left;
            }

            .toast-container {
                left: 10px;
                right: 10px;
                bottom: 70px;
            }

            .update-notification {
                left: 10px;
                right: 10px;
                bottom: 80px;
            }
        }

        /* ===== ERROR MESSAGES ===== */
        .error-message {
            color: #dc3545;
            font-size: 0.85rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .form-group.error input,
        .form-group.error select,
        .form-group.error textarea {
            border-color: #dc3545;
            background: #fff8f8;
        }

        .dark-mode .form-group.error input,
        .dark-mode .form-group.error select,
        .dark-mode .form-group.error textarea {
            background: #5c2b2b;
        }
    </style>
</head>
<body>
    <!-- Authentication Pages -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <h1><i class="fas fa-book-bible"></i> Ministry Report Book</h1>
                <p>Track and manage your ministry activity</p>
            </div>

            <div class="auth-tabs">
                <div class="auth-tab active" data-form="login">Login</div>
                <div class="auth-tab" data-form="signup">Sign Up</div>
            </div>

            <!-- Login Form -->
            <div class="auth-form active" id="loginForm">
                <form id="loginFormElement">
                    <div class="form-group">
                        <label for="loginEmail"><i class="fas fa-envelope"></i> Email</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="loginPassword"><i class="fas fa-lock"></i> Password</label>
                        <div class="password-input-group">
                            <input type="password" id="loginPassword" placeholder="Enter your password" required>
                            <button type="button" class="password-toggle" id="loginPasswordToggle">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-success" style="width: 100%;">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    </div>

                    <div class="form-group">
                        <button type="button" class="biometric-btn" id="biometricLoginBtn" style="width: 100%; margin-top: 10px;">
                            <i class="fas fa-fingerprint"></i> Use Biometric Login
                        </button>
                    </div>
                    
                    <div class="form-group" style="text-align: center;">
                        <p style="color: #666; font-size: 0.9rem;">
                            Don't have an account? <a href="#" id="switchToSignup" style="color: #0057a3; text-decoration: none; font-weight: 600;">Sign up here</a>
                        </p>
                        <p style="color: #666; font-size: 0.85rem; margin-top: 10px;">
                            <a href="#" id="forgotPassword" style="color: #6c757d; text-decoration: none;">Forgot password?</a>
                        </p>
                    </div>
                </form>
            </div>

            <!-- Sign Up Form -->
            <div class="auth-form" id="signupForm">
                <div class="signup-steps" id="signupSteps">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-label">Personal</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-label">Ministry</div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-label">Account</div>
                    </div>
                </div>

                <form id="signupFormElement">
                    <!-- Step 1: Personal Information -->
                    <div class="signup-step active" data-step="1">
                        <div class="form-group">
                            <label for="signupName"><i class="fas fa-user"></i> Full Name</label>
                            <input type="text" id="signupName" placeholder="Enter your full name" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="signupPhone"><i class="fas fa-phone"></i> Phone Number</label>
                                <input type="tel" id="signupPhone" placeholder="Enter your phone number">
                            </div>
                            
                            <div class="form-group">
                                <label for="signupLanguage"><i class="fas fa-language"></i> Language</label>
                                <select id="signupLanguage">
                                    <option value="en">English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="pt">Portuguese</option>
                                    <option value="de">German</option>
                                    <option value="it">Italian</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="signupCongregation"><i class="fas fa-church"></i> Congregation</label>
                            <div class="congregation-search">
                                <input type="text" id="signupCongregation" placeholder="Search for your congregation">
                                <button type="button" class="congregation-search-btn" id="searchCongregation">
                                    <i class="fas fa-search"></i>
                                </button>
                                <div class="congregation-suggestions" id="congregationSuggestions">
                                    <!-- Suggestions will be populated here -->
                                </div>
                            </div>
                            <small class="form-text" style="display: block; margin-top: 5px; color: #6c757d;">Start typing to search for congregations</small>
                        </div>
                        
                        <div class="profile-picture-upload">
                            <div class="profile-preview" id="profilePreview">
                                <i class="fas fa-user-circle" style="font-size: 4rem; color: #0057a3;"></i>
                            </div>
                            <button type="button" class="upload-btn" id="uploadProfilePicture">
                                <i class="fas fa-camera"></i> Upload Photo
                            </button>
                            <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
                        </div>
                        
                        <div class="step-navigation">
                            <button type="button" class="btn btn-info next-step" data-next="2" style="width: 100%;">
                                Next: Ministry Information <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Ministry Information -->
                    <div class="signup-step" data-step="2">
                        <div class="form-group">
                            <label><i class="fas fa-user-tie"></i> Ministry Type</label>
                            <div class="ministry-type-grid" id="ministryTypeGrid">
                                <div class="ministry-type-option" data-type="publisher">
                                    <i class="fas fa-user" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                                    <div>Publisher</div>
                                </div>
                                <div class="ministry-type-option" data-type="regular-pioneer">
                                    <i class="fas fa-fire" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                                    <div>Regular Pioneer</div>
                                </div>
                                <div class="ministry-type-option" data-type="special-pioneer">
                                    <i class="fas fa-star" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                                    <div>Special Pioneer</div>
                                </div>
                                <div class="ministry-type-option" data-type="elder">
                                    <i class="fas fa-shield-alt" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                                    <div>Elder</div>
                                </div>
                                <div class="ministry-type-option" data-type="ministerial-servant">
                                    <i class="fas fa-hands-helping" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                                    <div>Ministerial Servant</div>
                                </div>
                                <div class="ministry-type-option" data-type="other">
                                    <i class="fas fa-ellipsis-h" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                                    <div>Other</div>
                                </div>
                            </div>
                            <input type="hidden" id="ministryType" value="publisher" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="yearsInMinistry"><i class="fas fa-calendar-alt"></i> Years in Ministry</label>
                            <select id="yearsInMinistry">
                                <option value="0-1">Less than 1 year</option>
                                <option value="1-3">1-3 years</option>
                                <option value="3-5" selected>3-5 years</option>
                                <option value="5-10">5-10 years</option>
                                <option value="10+">10+ years</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="monthlyGoalInitial"><i class="fas fa-bullseye"></i> Monthly Hour Goal</label>
                            <input type="number" id="monthlyGoalInitial" min="1" max="300" value="50">
                            <small class="form-text" style="display: block; margin-top: 5px; color: #6c757d;">Set your personal monthly hour goal for ministry</small>
                        </div>
                        
                        <div class="step-navigation">
                            <button type="button" class="btn btn-secondary prev-step" data-prev="1" style="margin-right: 10px;">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                            <button type="button" class="btn btn-info next-step" data-next="3">
                                Next: Account Setup <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 3: Account Setup -->
                    <div class="signup-step" data-step="3">
                        <div class="form-group">
                            <label for="signupEmail"><i class="fas fa-envelope"></i> Email</label>
                            <input type="email" id="signupEmail" placeholder="Enter your email" required>
                            <small class="form-text" id="emailValidationText" style="display: block; margin-top: 5px; color: #6c757d;"></small>
                        </div>
                        
                        <div class="form-group">
                            <label for="signupPassword"><i class="fas fa-lock"></i> Password</label>
                            <div class="password-input-group">
                                <input type="password" id="signupPassword" placeholder="Create a password" required minlength="6">
                                <button type="button" class="password-toggle" id="signupPasswordToggle">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            
                            <div class="password-strength" id="passwordStrength">
                                <div class="strength-meter">
                                    <div class="strength-fill" id="strengthFill"></div>
                                </div>
                                <div class="strength-text" id="strengthText">Password strength</div>
                            </div>
                            
                            <ul class="password-criteria">
                                <li id="criteriaLength" class="criteria-unmet">
                                    <i class="fas fa-times-circle"></i> At least 6 characters
                                </li>
                                <li id="criteriaUppercase" class="criteria-unmet">
                                    <i class="fas fa-times-circle"></i> Contains uppercase letter
                                </li>
                                <li id="criteriaLowercase" class="criteria-unmet">
                                    <i class="fas fa-times-circle"></i> Contains lowercase letter
                                </li>
                                <li id="criteriaNumber" class="criteria-unmet">
                                    <i class="fas fa-times-circle"></i> Contains number
                                </li>
                                <li id="criteriaSpecial" class="criteria-unmet">
                                    <i class="fas fa-times-circle"></i> Contains special character
                                </li>
                            </ul>
                        </div>
                        
                        <div class="form-group">
                            <label for="signupConfirmPassword"><i class="fas fa-lock"></i> Confirm Password</label>
                            <div class="password-input-group">
                                <input type="password" id="signupConfirmPassword" placeholder="Confirm your password" required>
                                <button type="button" class="password-toggle" id="confirmPasswordToggle">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <small class="form-text" id="passwordMatchText" style="display: block; margin-top: 5px; color: #6c757d;"></small>
                        </div>
                        
                        <div class="terms-agreement">
                            <h4>Terms and Conditions</h4>
                            <p>By creating an account, you agree to use this app in accordance with the principles of Jehovah's Witnesses. This app is not affiliated with or endorsed by the Watch Tower Bible and Tract Society.</p>
                            <p>Your data will be stored locally on your device and can be backed up to your personal storage. We respect your privacy and do not collect personal information.</p>
                        </div>
                        
                        <div class="form-group">
                            <label for="agreeTerms" style="display: flex; align-items: flex-start; gap: 10px;">
                                <input type="checkbox" id="agreeTerms" required style="width: auto; margin-top: 3px;">
                                <span>I agree to the terms and conditions and confirm that I am one of Jehovah's Witnesses</span>
                            </label>
                        </div>
                        
                        <div class="step-navigation">
                            <button type="button" class="btn btn-secondary prev-step" data-prev="2" style="margin-right: 10px;">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                            <button type="submit" class="btn btn-success" id="signupSubmit" style="width: 100%;">
                                <i class="fas fa-user-plus"></i> Create Account
                            </button>
                        </div>
                    </div>
                </form>
                
                <div class="form-group" style="text-align: center; margin-top: 20px;">
                    <p style="color: #666; font-size: 0.9rem;">
                        Already have an account? <a href="#" id="switchToLogin" style="color: #0057a3; text-decoration: none; font-weight: 600;">Login here</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="app-container" id="appContainer">
        <!-- Dark Mode Toggle -->
        <button class="dark-mode-toggle" id="darkModeToggle">
            <i class="fas fa-moon"></i>
        </button>

        <!-- Sync Status -->
        <div class="sync-status" id="syncStatus">
            <i class="fas fa-check-circle"></i>
            <span>Synced</span>
        </div>

        <!-- Offline Status -->
        <div class="offline-status hidden" id="offlineStatus">
            <i class="fas fa-wifi-slash"></i>
            <span>You're currently offline. Data will sync when connection is restored.</span>
        </div>

        <header>
            <div class="container">
                <div class="user-menu">
                    <div class="user-info" id="userInfo">
                        <i class="fas fa-user-circle"></i> Loading...
                    </div>
                    <button class="logout-btn" id="logoutButton">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
                
                <h1><i class="fas fa-book-bible"></i> Ministry Report Book</h1>
                <p>Track and manage your ministry activity - For Jehovah's Witnesses</p>
            </div>
        </header>

        <div class="container">
            <div class="nav-tabs">
                <div class="tab active" data-page="dashboard">
                    <i class="fas fa-home"></i> Dashboard
                </div>
                <div class="tab" data-page="report">
                    <i class="fas fa-plus-circle"></i> Add Report
                </div>
                <div class="tab" data-page="bible-studies">
                    <i class="fas fa-book-open"></i> Bible Studies
                </div>
                <div class="tab" data-page="reports">
                    <i class="fas fa-history"></i> View Reports
                </div>
                <div class="tab" data-page="tools">
                    <i class="fas fa-tools"></i> Tools
                </div>
            </div>

            <!-- Bottom Navigation for Mobile -->
            <div class="bottom-nav" id="bottomNav">
                <a href="#" class="bottom-nav-item active" data-page="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="bottom-nav-item" data-page="report">
                    <i class="fas fa-plus-circle"></i>
                    <span>Add Report</span>
                </a>
                <a href="#" class="bottom-nav-item" data-page="bible-studies">
                    <i class="fas fa-book-open"></i>
                    <span>Studies</span>
                </a>
                <a href="#" class="bottom-nav-item" data-page="reports">
                    <i class="fas fa-history"></i>
                    <span>Reports</span>
                </a>
                <a href="#" class="bottom-nav-item" data-page="tools">
                    <i class="fas fa-cog"></i>
                    <span>Tools</span>
                </a>
            </div>

            <!-- Dashboard Page -->
            <div class="page active pull-to-refresh" id="dashboard">
                <div class="refresh-indicator">
                    <i class="fas fa-sync-alt"></i>
                </div>
                <div class="scripture">
                    <p><i class="fas fa-quote-left"></i> Go, therefore, and make disciples of people of all the nations, baptizing them in the name of the Father and of the Son and of the holy spirit. ‚Äî Matthew 28:19</p>
                </div>

                <div class="dashboard">
                    <div class="card">
                        <h2><i class="fas fa-chart-line"></i> <span id="currentMonthSummary">Monthly Summary</span></h2>
                        <div class="stats">
                            <div class="stat-box">
                                <div class="stat-value" id="monthHours">0</div>
                                <div class="stat-label">Hours This Month</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="monthStudies">0</div>
                                <div class="stat-label">Bible Studies</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="monthDaysWorked">0</div>
                                <div class="stat-label">Days Worked</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="monthAvgHours">0</div>
                                <div class="stat-label">Avg Hours/Day</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2><i class="fas fa-calendar-alt"></i> Yearly Overview</h2>
                        <div id="yearlyOverview" class="yearly-grid">
                            <!-- Yearly overview will be dynamically generated -->
                        </div>
                    </div>

                    <div class="card">
                        <h2><i class="fas fa-bell"></i> Follow-up Reminders</h2>
                        <div id="followUpReminders">
                            <div class="empty-state">
                                <i class="fas fa-check-circle"></i>
                                <p>No pending follow-ups. Great job keeping up with your ministry!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="dashboard">
                    <div class="card">
                        <h2><i class="fas fa-bullseye"></i> Pioneer Goals</h2>
                        <div id="pioneerProgress">
                            <div class="progress-container">
                                <div class="progress-label" id="monthlyGoalLabel">Monthly Hours Goal: 50</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="hoursProgress" style="width: 0%"></div>
                                </div>
                                <div class="progress-text" id="hoursText">0/50 hours completed</div>
                            </div>
                            
                            <div class="goal-calculator">
                                <h3><i class="fas fa-calculator"></i> Weekly Schedule Calculator</h3>
                                <div class="calculator-result" id="calculatorResult" style="display: none;">
                                    <div class="result-item">
                                        <span>Hours needed weekly:</span>
                                        <strong id="weeklyHours">0</strong>
                                    </div>
                                    <div class="result-item">
                                        <span>Days remaining in month:</span>
                                        <strong id="daysRemaining">0</strong>
                                    </div>
                                    <div class="result-item">
                                        <span>Weeks remaining:</span>
                                        <strong id="weeksRemaining">0</strong>
                                    </div>
                                    <div class="result-item">
                                        <span>Recommended daily hours:</span>
                                        <strong id="dailyHours">0</strong>
                                    </div>
                                </div>
                                <button class="btn btn-info" id="calculatePioneer" style="margin-top: 15px; width: 100%;">
                                    <i class="fas fa-calculator"></i> Calculate Weekly Schedule
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Report Page -->
            <div class="page" id="report">
                <div class="scripture">
                    <p><i class="fas fa-quote-left"></i> Preach the word; be at it urgently in favorable times and difficult times. ‚Äî 2 Timothy 4:2</p>
                </div>

                <div class="card">
                    <h2><i class="fas fa-plus-circle"></i> Add Ministry Report</h2>
                    <form id="reportForm">
                        <div class="form-group">
                            <label for="reportDate"><i class="fas fa-calendar"></i> Date</label>
                            <input type="date" id="reportDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="hours"><i class="fas fa-clock"></i> Hours</label>
                            <input type="number" id="hours" step="0.25" min="0" placeholder="e.g., 2.5" required>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-book-open"></i> Bible Studies Conducted Today</label>
                            <div class="bible-studies-grid" id="bibleStudiesChecklist">
                                <div class="empty-state" style="grid-column: 1 / -1;">
                                    <i class="fas fa-book"></i>
                                    <p>No Bible studies added yet. Add them in the Bible Studies page.</p>
                                </div>
                            </div>
                            <small class="form-text" style="display: block; margin-top: 5px; color: #6c757d;">
                                Select Bible studies conducted today. Once a study is selected for a day, 
                                it won't be counted again if selected on another day (prevents double counting).
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="notes"><i class="fas fa-sticky-note"></i> Notes</label>
                            <textarea id="notes" rows="3" placeholder="Additional notes about your ministry activity..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <div class="timer-section">
                                <h3><i class="fas fa-stopwatch"></i> Time Tracker</h3>
                                <div class="timer-display">
                                    <span id="timerDisplay">00:00:00</span>
                                </div>
                                <div class="timer-controls">
                                    <button type="button" class="btn btn-success" id="startTimer">
                                        <i class="fas fa-play"></i> Start Timer
                                    </button>
                                    <button type="button" class="btn btn-warning" id="pauseTimer" disabled>
                                        <i class="fas fa-pause"></i> Pause
                                    </button>
                                    <button type="button" class="btn btn-info" id="saveTimer" disabled>
                                        <i class="fas fa-save"></i> Save Time
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="actions">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check"></i> Save Report
                            </button>
                            <button type="button" class="btn btn-secondary" id="clearReportForm">
                                <i class="fas fa-eraser"></i> Clear Form
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Bible Studies Page -->
            <div class="page" id="bible-studies">
                <div class="scripture">
                    <p><i class="fas fa-quote-left"></i> Your word is a lamp to my foot, and a light for my path. ‚Äî Psalm 119:105</p>
                </div>

                <div class="dashboard">
                    <div class="card">
                        <h2><i class="fas fa-plus-circle"></i> Add Bible Study</h2>
                        <form id="studyForm">
                            <div class="form-group">
                                <label for="studyName"><i class="fas fa-user"></i> Student Name</label>
                                <input type="text" id="studyName" placeholder="Enter student's name" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="studyAddress"><i class="fas fa-map-marker-alt"></i> Address</label>
                                <input type="text" id="studyAddress" placeholder="Enter address for mapping">
                            </div>
                            
                            <div class="form-group">
                                <div class="map-container">
                                    <div id="studyMap"></div>
                                    <div class="map-toolbar">
                                        <button type="button" class="map-tool" id="drawPolygon" title="Draw Area">
                                            <i class="fas fa-draw-polygon"></i>
                                        </button>
                                        <button type="button" class="map-tool" id="addMarker" title="Add Marker">
                                            <i class="fas fa-map-marker-alt"></i>
                                        </button>
                                        <button type="button" class="map-tool" id="measureDistance" title="Measure Distance">
                                            <i class="fas fa-ruler"></i>
                                        </button>
                                        <button type="button" class="map-tool" id="fullscreenMap" title="Fullscreen">
                                            <i class="fas fa-expand"></i>
                                        </button>
                                        <button type="button" class="map-tool" id="cacheMap" title="Cache Map for Offline">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </div>
                                    <div class="map-controls">
                                        <button type="button" class="map-btn" id="locateAddress">
                                            <i class="fas fa-search-location"></i> Locate
                                        </button>
                                        <button type="button" class="map-btn" id="saveLocation">
                                            <i class="fas fa-map-pin"></i> Save Location
                                        </button>
                                    </div>
                                </div>
                                <small class="form-text" style="display: block; margin-top: 5px; color: #6c757d;">Search for the address above, then click "Locate" and "Save Location" to save the map coordinates.</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="studyPhone"><i class="fas fa-phone"></i> Phone Number</label>
                                <input type="tel" id="studyPhone" placeholder="Enter phone number">
                            </div>
                            
                            <div class="form-group">
                                <label for="studyStartDate"><i class="fas fa-calendar-plus"></i> Start Date</label>
                                <input type="date" id="studyStartDate" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="studyNotes"><i class="fas fa-sticky-note"></i> Notes</label>
                                <textarea id="studyNotes" rows="3" placeholder="Notes about the study..."></textarea>
                            </div>
                            
                            <div class="actions">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-check"></i> Add Study
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="card">
                        <h2><i class="fas fa-list"></i> Active Bible Studies</h2>
                        <div id="studiesList">
                            <!-- Bible studies will be dynamically generated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- View Reports Page -->
            <div class="page" id="reports">
                <div class="scripture">
                    <p><i class="fas fa-quote-left"></i> Whatever you are doing, work at it whole-souled as for Jehovah. ‚Äî Colossians 3:23</p>
                </div>

                <div class="card">
                    <h2><i class="fas fa-history"></i> Ministry Reports</h2>
                    
                    <div class="filter-section">
                        <div class="form-group">
                            <label for="reportFilter"><i class="fas fa-filter"></i> Filter by Month</label>
                            <select id="reportFilter">
                                <option value="all">All Reports</option>
                                <option value="current">Current Month</option>
                                <option value="last">Last Month</option>
                                <!-- Months will be dynamically added -->
                            </select>
                        </div>
                    </div>
                    
                    <div id="reportsList">
                        <!-- Reports will be dynamically generated here -->
                    </div>
                    
                    <div class="summary-section" style="margin-top: 30px;">
                        <h3><i class="fas fa-chart-bar"></i> Monthly Summary</h3>
                        <div id="reportSummary" class="stats">
                            <!-- Summary will be dynamically generated -->
                        </div>
                        <button class="btn btn-info" id="exportReports" style="margin-top: 20px;">
                            <i class="fas fa-file-export"></i> Export Reports
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tools Page -->
            <div class="page" id="tools">
                <div class="scripture">
                    <p><i class="fas fa-quote-left"></i> The wise one has many advisers. ‚Äî Proverbs 11:14</p>
                </div>

                <div class="dashboard">
                    <div class="card">
                        <h2><i class="fas fa-cog"></i> Settings</h2>
                        <form id="settingsForm">
                            <div class="form-group">
                                <label for="userName"><i class="fas fa-user"></i> Your Name</label>
                                <input type="text" id="userName" placeholder="Enter your name">
                            </div>
                            
                            <div class="form-group">
                                <label for="monthlyGoal"><i class="fas fa-bullseye"></i> Monthly Hour Goal</label>
                                <input type="number" id="monthlyGoal" min="1" value="50">
                                <small class="form-text" style="display: block; margin-top: 5px; color: #6c757d;">Set your monthly pioneer hour goal</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="enableReminders">
                                    <input type="checkbox" id="enableReminders" checked>
                                    <i class="fas fa-bell"></i> Enable Follow-up Reminders
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label for="reminderDays"><i class="fas fa-clock"></i> Reminder Days Before</label>
                                <input type="number" id="reminderDays" min="1" max="30" value="7">
                                <small class="form-text" style="display: block; margin-top: 5px; color: #6c757d;">Days before follow-up to remind you</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="enableCloudSync">
                                    <input type="checkbox" id="enableCloudSync">
                                    <i class="fas fa-cloud"></i> Enable Cloud Sync
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label for="enableNotifications">
                                    <input type="checkbox" id="enableNotifications">
                                    <i class="fas fa-bell"></i> Enable Push Notifications
                                </label>
                            </div>
                            
                            <div class="actions">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> Save Settings
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="card">
                        <h2><i class="fas fa-tools"></i> Data Management</h2>
                        
                        <div class="data-actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button class="btn btn-info" id="backupData">
                                <i class="fas fa-download"></i> Backup Data
                            </button>
                            <button class="btn btn-warning" id="restoreData">
                                <i class="fas fa-upload"></i> Restore Data
                            </button>
                            <button class="btn btn-danger" id="clearAllData" style="grid-column: 1 / -1;">
                                <i class="fas fa-trash"></i> Clear All Data
                            </button>
                        </div>
                        
                        <div class="storage-info" style="margin-top: 20px;">
                            <h4><i class="fas fa-database"></i> Storage Information</h4>
                            <div class="storage-meter">
                                <div class="storage-fill" id="storageFill" style="width: 0%"></div>
                            </div>
                            <p id="storageStatus" style="margin-top: 10px;">Calculating storage usage...</p>
                        </div>
                    </div>

                    <div class="card">
                        <h2><i class="fas fa-chart-pie"></i> Statistics</h2>
                        <div class="stats-chart">
                            <canvas id="statsChart"></canvas>
                        </div>
                        <button class="btn btn-info" id="refreshStats" style="margin-top: 15px; width: 100%;">
                            <i class="fas fa-sync-alt"></i> Refresh Statistics
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>¬© <span id="currentYear"></span> Ministry Report Book - For Jehovah's Witnesses | Not affiliated with Watch Tower Bible and Tract Society</p>
            <p style="font-size: 0.8rem; opacity: 0.8; margin-top: 5px;">Data is stored locally in your browser | Compatible with mobile devices</p>
        </footer>

        <!-- PWA Install Button -->
        <button class="pwa-install-btn hidden" id="installButton">
            <i class="fas fa-download"></i> Install App
        </button>

        <!-- Update Notification -->
        <div class="update-notification" id="updateNotification">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong><i class="fas fa-sync-alt"></i> Update Available</strong>
                    <p style="margin: 5px 0 0 0; font-size: 0.9rem;">A new version is available. Restart to update.</p>
                </div>
                <button class="btn btn-success" id="updateApp">
                    <i class="fas fa-redo"></i> Update
                </button>
            </div>
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Confirmation Modal -->
        <div class="modal" id="confirmationModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">Confirm Action</h3>
                    <button class="close-modal" id="closeModal">&times;</button>
                </div>
                <p id="modalMessage">Are you sure you want to perform this action?</p>
                <div class="actions" style="margin-top: 30px;">
                    <button class="btn btn-danger" id="modalConfirm">Confirm</button>
                    <button class="btn btn-secondary" id="modalCancel">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Summary Modal -->
        <div class="modal" id="summaryModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-chart-bar"></i> Ministry Summary</h3>
                    <button class="close-modal" id="closeSummaryModal">&times;</button>
                </div>
                <div id="summaryContent">
                    <!-- Summary content will be dynamically generated here -->
                </div>
            </div>
        </div>

        <!-- Forgot Password Modal -->
        <div class="modal" id="forgotPasswordModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-key"></i> Reset Password</h3>
                    <button class="close-modal" id="closeForgotPasswordModal">&times;</button>
                </div>
                <form id="forgotPasswordForm">
                    <div class="form-group">
                        <label for="resetEmail"><i class="fas fa-envelope"></i> Email Address</label>
                        <input type="email" id="resetEmail" placeholder="Enter your email address" required>
                        <small class="form-text" style="display: block; margin-top: 5px; color: #6c757d;">Enter the email address associated with your account</small>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-success" style="width: 100%;">
                            <i class="fas fa-paper-plane"></i> Send Reset Link
                        </button>
                    </div>
                    <div style="text-align: center;">
                        <p style="color: #666; font-size: 0.9rem;">
                            Remember your password? <a href="#" id="backToLogin" style="color: #0057a3; text-decoration: none; font-weight: 600;">Login here</a>
                        </p>
                    </div>
                </form>
            </div>
        </div>

        <!-- Biometric Login Modal -->
        <div class="modal" id="biometricModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-fingerprint"></i> Biometric Login</h3>
                    <button class="close-modal" id="closeBiometricModal">&times;</button>
                </div>
                <div style="text-align: center; padding: 30px;">
                    <div class="splash-logo" style="font-size: 3rem; margin-bottom: 20px;">
                        <i class="fas fa-fingerprint"></i>
                    </div>
                    <p>Use your fingerprint or face ID to login</p>
                    <button class="biometric-btn" id="useBiometric" style="margin: 20px auto;">
                        <i class="fas fa-fingerprint"></i> Authenticate
                    </button>
                    <p style="margin-top: 20px;">
                        <a href="#" id="usePassword" style="color: #0057a3;">Use password instead</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Privacy Policy Modal -->
        <div class="modal" id="privacyPolicyModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-shield-alt"></i> Privacy Policy</h3>
                    <button class="close-modal" id="closePrivacyModal">&times;</button>
                </div>
                <div style="max-height: 400px; overflow-y: auto; padding: 20px;">
                    <h4>Data Collection and Usage</h4>
                    <p>This app stores your ministry data locally on your device. No personal data is sent to external servers unless you explicitly enable cloud sync.</p>
                    
                    <h4>Cloud Sync (Optional)</h4>
                    <p>When enabled, your data is encrypted and stored securely in the cloud for backup and multi-device synchronization.</p>
                    
                    <h4>Third-Party Services</h4>
                    <p>We use Firebase for authentication and push notifications (if enabled). Firebase's privacy policy applies to their services.</p>
                    
                    <h4>Your Rights</h4>
                    <p>You can export or delete your data at any time through the app's settings. Local data is automatically cleared when you log out.</p>
                    
                    <h4>Contact</h4>
                    <p>For privacy concerns, please contact: privacy@ministryapp.example.com</p>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button class="btn btn-primary" id="acceptPrivacyPolicy">
                            <i class="fas fa-check"></i> I Understand
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // APP INITIALIZATION
        // ============================================

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCBRCHFdsq-XyBTUEaFmAEj5hvlZw_Md9c",
            authDomain: "preaching-reports.firebaseapp.com",
            projectId: "preaching-reports",
            storageBucket: "preaching-reports.firebasestorage.app",
            messagingSenderId: "864072634898",
            appId: "1:864072634898:web:a2a897b55269fa7470fecb",
            measurementId: "G-ZV85TESXDH"
        };

        // Firebase services
        let firebaseApp, firebaseAuth, firestore, firebaseMessaging, firebaseStorage, firebaseAnalytics;
        
        // Initialize Firebase if available
        if (typeof firebase !== 'undefined') {
            try {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                firebaseAuth = firebase.auth();
                firestore = firebase.firestore();
                firebaseMessaging = firebase.messaging();
                firebaseStorage = firebase.storage();
                firebaseAnalytics = firebase.analytics();
                
                // Enable offline persistence
                firestore.enablePersistence()
                    .catch((err) => {
                        if (err.code === 'failed-precondition') {
                            console.log('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                        } else if (err.code === 'unimplemented') {
                            console.log('The current browser doesn\'t support persistence.');
                        }
                    });
            } catch (error) {
                console.log('Firebase initialization failed, using local storage only:', error);
            }
        }

        // User management
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('appUsers')) || [];
        
        // Core application data
        let reports = [];
        let bibleStudies = [];
        let appSettings = {
            userName: '',
            monthlyGoal: 50,
            enableReminders: true,
            reminderDays: 7,
            enableCloudSync: false,
            enableNotifications: false,
            darkMode: false
        };
        
        // Timer variables
        let timerSeconds = 0;
        let timerInterval = null;
        let isTimerRunning = false;
        
        // Map variables
        let studyMap = null;
        let studyMarker = null;
        let selectedStudyLocation = null;
        let mapTools = {
            polygon: null,
            markers: [],
            measure: null,
            drawControl: null
        };
        
        // Chart instance
        let statsChart = null;
        
        // Track studies conducted today
        let studiesConductedToday = new Set();
        
        // Offline queue for sync
        let offlineQueue = [];
        let isSyncing = false;
        
        // Enhanced signup variables
        let userProfilePicture = null;
        let signupStep = 1;
        const congregationSuggestions = [
            "New York Kingdom Hall - Brooklyn",
            "Los Angeles Congregation - Downtown",
            "Chicago Assembly Hall",
            "Miami Spanish Congregation",
            "London Central Congregation",
            "Toronto East Congregation",
            "Sydney International Congregation",
            "Johannesburg English Congregation",
            "Berlin German Congregation",
            "Paris French Congregation",
            "Tokyo Japanese Congregation",
            "Seoul Korean Congregation",
            "Mexico City Spanish Congregation",
            "S√£o Paulo Portuguese Congregation",
            "Moscow Russian Congregation"
        ];

        // ============================================
        // CORE APP FUNCTIONS
        // ============================================

        function initializeApp() {
            // Set current year in footer
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // Set default dates to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
            document.getElementById('studyStartDate').value = today;
            
            // Initialize settings
            loadSettings();
            
            // Initialize UI
            updateDashboard();
            updateStudiesList();
            updateReportsList();
            updateStatisticsChart();
            
            // Initialize timer display
            document.getElementById('timerDisplay').textContent = formatTime(timerSeconds);
            
            // Setup app event listeners
            setupAppEventListeners();
            
            // Setup enhanced features
            initializeEnhancedFeatures();
            
            // Setup PWA
            setupPWA();
            
            // Setup offline detection
            setupOfflineDetection();
            
            // Setup cloud sync
            setupCloudSync();
            
            // Show welcome message
            setTimeout(() => {
                showToast(`Welcome ${currentUser?.name}! Current month: ${getCurrentMonthName()}`, 'success');
            }, 1000);
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('appSettings');
            if (savedSettings) {
                appSettings = JSON.parse(savedSettings);
            }
            
            // Apply settings to UI
            document.getElementById('userName').value = appSettings.userName || currentUser?.name || '';
            document.getElementById('monthlyGoal').value = appSettings.monthlyGoal || 50;
            document.getElementById('enableReminders').checked = appSettings.enableReminders !== false;
            document.getElementById('reminderDays').value = appSettings.reminderDays || 7;
            document.getElementById('enableCloudSync').checked = appSettings.enableCloudSync || false;
            document.getElementById('enableNotifications').checked = appSettings.enableNotifications || false;
            
            // Apply dark mode
            if (appSettings.darkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').innerHTML = '<i class="fas fa-sun"></i>';
            }
        }

        function saveSettings() {
            localStorage.setItem('appSettings', JSON.stringify(appSettings));
        }

        function updateDashboard() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const monthName = getCurrentMonthName();
            
            // Filter reports for current month
            const monthReports = reports.filter(report => {
                const reportDate = new Date(report.date);
                return reportDate.getMonth() === currentMonth && 
                       reportDate.getFullYear() === currentYear;
            });
            
            // Calculate statistics
            const monthHours = monthReports.reduce((sum, report) => sum + (parseFloat(report.hours) || 0), 0);
            
            // Count unique bible studies conducted this month
            const studiesThisMonth = new Set();
            monthReports.forEach(report => {
                if (report.bibleStudies && Array.isArray(report.bibleStudies)) {
                    report.bibleStudies.forEach(studyId => {
                        studiesThisMonth.add(studyId);
                    });
                }
            });
            const monthStudies = studiesThisMonth.size;
            
            const monthDaysWorked = new Set(monthReports.map(r => r.date)).size;
            const monthAvgHours = monthDaysWorked > 0 ? (monthHours / monthDaysWorked).toFixed(1) : 0;
            
            // Update DOM
            document.getElementById('monthHours').textContent = monthHours.toFixed(1);
            document.getElementById('monthStudies').textContent = monthStudies;
            document.getElementById('monthDaysWorked').textContent = monthDaysWorked;
            document.getElementById('monthAvgHours').textContent = monthAvgHours;
            document.getElementById('currentMonthSummary').textContent = `${monthName} Summary`;
            
            // Update pioneer goals
            const goal = appSettings.monthlyGoal || 50;
            const progress = Math.min((monthHours / goal) * 100, 100);
            document.getElementById('hoursProgress').style.width = `${progress}%`;
            document.getElementById('hoursText').textContent = `${monthHours.toFixed(1)}/${goal} hours completed`;
            document.getElementById('monthlyGoalLabel').textContent = `Monthly Hours Goal: ${goal}`;
            
            // Update yearly overview
            updateYearlyOverview();
            
            // Update follow-up reminders
            updateFollowUpReminders();
            
            // Update bible studies checklist
            updateBibleStudiesChecklist();
            
            // Update storage info
            updateStorageInfo();
        }

        function updateStorageInfo() {
            const dataSize = JSON.stringify({
                reports: reports,
                studies: bibleStudies,
                settings: appSettings
            }).length;
            
            const sizeKB = (dataSize / 1024).toFixed(2);
            const maxSize = 5 * 1024 * 1024; // 5MB
            const percentage = Math.min((dataSize / maxSize) * 100, 100);
            
            document.getElementById('storageFill').style.width = `${percentage}%`;
            document.getElementById('storageStatus').textContent = `${sizeKB} KB used (${percentage.toFixed(1)}% of 5MB)`;
        }

        function updateYearlyOverview() {
            const yearlyGrid = document.getElementById('yearlyOverview');
            yearlyGrid.innerHTML = '';
            
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const now = new Date();
            
            months.forEach((month, index) => {
                const monthCell = document.createElement('div');
                monthCell.className = 'month-cell';
                if (index === now.getMonth()) {
                    monthCell.classList.add('active');
                }
                
                // Calculate month total
                const monthReports = reports.filter(report => {
                    const reportDate = new Date(report.date);
                    return reportDate.getMonth() === index && 
                           reportDate.getFullYear() === now.getFullYear();
                });
                
                const monthHours = monthReports.reduce((sum, report) => sum + (parseFloat(report.hours) || 0), 0);
                
                monthCell.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 5px;">${month}</div>
                    <div style="font-size: 0.9rem; color: #28a745;">${monthHours.toFixed(0)}h</div>
                `;
                
                monthCell.addEventListener('click', () => {
                    showMonthSummary(index);
                });
                
                yearlyGrid.appendChild(monthCell);
            });
        }

        function updateBibleStudiesChecklist() {
            const checklist = document.getElementById('bibleStudiesChecklist');
            const activeStudies = bibleStudies.filter(study => study.status === 'active');
            
            if (activeStudies.length === 0) {
                checklist.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-book"></i>
                        <p>No Bible studies added yet. Add them in the Bible Studies page.</p>
                    </div>
                `;
                return;
            }
            
            checklist.innerHTML = '';
            
            activeStudies.forEach(study => {
                const studyElement = document.createElement('div');
                studyElement.className = 'study-checkbox';
                studyElement.innerHTML = `
                    <input type="checkbox" id="study_${study.id}" value="${study.id}" 
                           ${studiesConductedToday.has(study.id) ? 'checked' : ''}>
                    <label for="study_${study.id}">${study.name}</label>
                `;
                
                studyElement.querySelector('input').addEventListener('change', function() {
                    if (this.checked) {
                        studiesConductedToday.add(study.id);
                    } else {
                        studiesConductedToday.delete(study.id);
                    }
                });
                
                checklist.appendChild(studyElement);
            });
        }

        function updateFollowUpReminders() {
            const remindersDiv = document.getElementById('followUpReminders');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Get upcoming follow-ups (active studies not conducted today)
            const activeStudies = bibleStudies.filter(study => study.status === 'active');
            const upcomingStudies = activeStudies.filter(study => {
                // Check if study was conducted today
                const todayStr = today.toISOString().split('T')[0];
                const conductedToday = reports.some(report => {
                    if (report.date === todayStr && report.bibleStudies) {
                        return report.bibleStudies.includes(study.id);
                    }
                    return false;
                });
                
                // Show reminder if not conducted today
                return !conductedToday;
            });
            
            if (upcomingStudies.length === 0) {
                remindersDiv.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <p>No pending follow-ups. Great job keeping up with your ministry!</p>
                    </div>
                `;
            } else {
                remindersDiv.innerHTML = '';
                upcomingStudies.forEach(study => {
                    const reminderItem = document.createElement('div');
                    reminderItem.className = 'reminder-item swipe-item';
                    reminderItem.innerHTML = `
                        <div>
                            <strong>${study.name}</strong>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                ${study.address ? `${study.address} ‚Ä¢ ` : ''}
                                ${study.phone || ''}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <button class="btn btn-sm btn-success" onclick="markStudyComplete('${study.id}')" style="margin-top: 5px;">
                                <i class="fas fa-check"></i> Mark Studied
                            </button>
                        </div>
                        <div class="swipe-actions">
                            <div class="swipe-action complete" data-action="complete">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="swipe-action delete" data-action="delete">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    `;
                    
                    // Add swipe functionality
                    addSwipeToElement(reminderItem, 
                        () => deleteStudy(study.id),
                        () => markStudyComplete(study.id)
                    );
                    
                    remindersDiv.appendChild(reminderItem);
                });
            }
        }

        function updateStudiesList() {
            const studiesList = document.getElementById('studiesList');
            const activeStudies = bibleStudies.filter(study => study.status === 'active');
            
            if (activeStudies.length === 0) {
                studiesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-book"></i>
                        <p>No active Bible studies. Start one today!</p>
                    </div>
                `;
            } else {
                studiesList.innerHTML = '';
                activeStudies.forEach(study => {
                    const studyElement = document.createElement('div');
                    studyElement.className = 'reminder-item swipe-item';
                    
                    // Count how many times this study was conducted
                    const studyCount = reports.reduce((count, report) => {
                        if (report.bibleStudies && report.bibleStudies.includes(study.id)) {
                            return count + 1;
                        }
                        return count;
                    }, 0);
                    
                    studyElement.innerHTML = `
                        <div>
                            <strong>${study.name}</strong>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                ${study.phone ? `${study.phone} ‚Ä¢ ` : ''}
                                ${study.address || ''}
                            </div>
                            <div style="font-size: 0.85rem; color: #28a745; margin-top: 5px;">
                                <i class="fas fa-calendar"></i> Started: ${new Date(study.startDate).toLocaleDateString()} ‚Ä¢
                                <i class="fas fa-check-circle"></i> Conducted: ${studyCount} times
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <button class="btn btn-sm btn-info" onclick="editStudy('${study.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteStudy('${study.id}')" style="margin-left: 5px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="swipe-actions">
                            <div class="swipe-action edit" data-action="edit">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="swipe-action delete" data-action="delete">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    `;
                    
                    // Add swipe functionality
                    addSwipeToElement(studyElement,
                        () => deleteStudy(study.id),
                        () => editStudy(study.id)
                    );
                    
                    studiesList.appendChild(studyElement);
                });
            }
            
            // Update checklist as well
            updateBibleStudiesChecklist();
        }

        function updateReportsList() {
            const reportsList = document.getElementById('reportsList');
            const filter = document.getElementById('reportFilter').value;
            
            let filteredReports = [...reports];
            
            if (filter === 'current') {
                const now = new Date();
                filteredReports = reports.filter(report => {
                    const reportDate = new Date(report.date);
                    return reportDate.getMonth() === now.getMonth() && 
                           reportDate.getFullYear() === now.getFullYear();
                });
            } else if (filter === 'last') {
                const now = new Date();
                const lastMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
                const year = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
                
                filteredReports = reports.filter(report => {
                    const reportDate = new Date(report.date);
                    return reportDate.getMonth() === lastMonth && 
                           reportDate.getFullYear() === year;
                });
            }
            
            // Sort by date (newest first)
            filteredReports.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filteredReports.length === 0) {
                reportsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-file-alt"></i>
                        <p>No reports found. Start by adding your first ministry report!</p>
                    </div>
                `;
            } else {
                reportsList.innerHTML = '';
                filteredReports.forEach(report => {
                    const reportElement = document.createElement('div');
                    reportElement.className = 'reminder-item swipe-item';
                    
                    // Get bible study names
                    let studyNames = [];
                    if (report.bibleStudies && Array.isArray(report.bibleStudies)) {
                        report.bibleStudies.forEach(studyId => {
                            const study = bibleStudies.find(s => s.id === studyId);
                            if (study) {
                                studyNames.push(study.name);
                            }
                        });
                    }
                    
                    reportElement.innerHTML = `
                        <div>
                            <strong>${new Date(report.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</strong>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                <i class="fas fa-clock"></i> ${parseFloat(report.hours).toFixed(1)} hours
                            </div>
                            ${studyNames.length > 0 ? `
                                <div style="font-size: 0.85rem; color: #28a745; margin-top: 5px;">
                                    <i class="fas fa-book-open"></i> Studies: ${studyNames.join(', ')}
                                </div>
                            ` : ''}
                            ${report.notes ? `<div style="font-size: 0.85rem; margin-top: 5px;">${report.notes}</div>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <button class="btn btn-sm btn-danger" onclick="deleteReport('${report.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="swipe-actions">
                            <div class="swipe-action delete" data-action="delete">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    `;
                    
                    // Add swipe functionality
                    addSwipeToElement(reportElement,
                        () => deleteReport(report.id),
                        null
                    );
                    
                    reportsList.appendChild(reportElement);
                });
            }
            
            // Update filter options
            updateReportFilterOptions();
            
            // Update summary
            updateReportSummary(filteredReports);
        }

        function updateStatisticsChart() {
            const ctx = document.getElementById('statsChart').getContext('2d');
            
            // Destroy existing chart
            if (statsChart) {
                statsChart.destroy();
            }
            
            // Get last 6 months data
            const now = new Date();
            const months = [];
            const hoursData = [];
            const studiesData = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthName = date.toLocaleDateString('en-US', { month: 'short' });
                months.push(monthName);
                
                const monthReports = reports.filter(report => {
                    const reportDate = new Date(report.date);
                    return reportDate.getMonth() === date.getMonth() && 
                           reportDate.getFullYear() === date.getFullYear();
                });
                
                // Calculate total hours
                const totalHours = monthReports.reduce((sum, report) => sum + (parseFloat(report.hours) || 0), 0);
                hoursData.push(totalHours);
                
                // Count unique studies
                const uniqueStudies = new Set();
                monthReports.forEach(report => {
                    if (report.bibleStudies && Array.isArray(report.bibleStudies)) {
                        report.bibleStudies.forEach(studyId => {
                            uniqueStudies.add(studyId);
                        });
                    }
                });
                studiesData.push(uniqueStudies.size);
            }
            
            // Create chart
            statsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Hours',
                            data: hoursData,
                            borderColor: '#0057a3',
                            backgroundColor: 'rgba(0, 87, 163, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Bible Studies',
                            data: studiesData,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '6-Month Ministry Trend',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        }
                    }
                }
            });
        }

        // ============================================
        // ENHANCED FEATURES
        // ============================================

        function initializeEnhancedFeatures() {
            setupBottomNavigation();
            setupSwipeActions();
            setupPullToRefresh();
            setupDarkMode();
            setupEnhancedSignup();
            setupBiometricLogin();
            setupEnhancedMaps();
            setupNotifications();
            setupDataManagement();
            setupPWAFeatures();
            setupErrorTracking();
            setupEncryption();
            setupPrivacyPolicy();
        }

        function setupBottomNavigation() {
            const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
            const tabs = document.querySelectorAll('.tab');
            
            bottomNavItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    
                    // Update active states
                    bottomNavItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Trigger main tab click
                    const mainTab = document.querySelector(`.tab[data-page="${page}"]`);
                    if (mainTab) {
                        mainTab.click();
                    }
                });
            });
            
            // Update bottom nav when main tabs change
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    bottomNavItems.forEach(item => {
                        item.classList.remove('active');
                        if (item.getAttribute('data-page') === page) {
                            item.classList.add('active');
                        }
                    });
                });
            });
            
            // Show/hide bottom nav based on screen size
            function updateBottomNav() {
                const bottomNav = document.getElementById('bottomNav');
                if (window.innerWidth <= 768) {
                    bottomNav.style.display = 'flex';
                } else {
                    bottomNav.style.display = 'none';
                }
            }
            
            updateBottomNav();
            window.addEventListener('resize', updateBottomNav);
        }

        function setupSwipeActions() {
            window.addSwipeToElement = function(element, deleteCallback, editCallback) {
                let touchStartX = 0;
                let touchEndX = 0;
                let isSwiping = false;
                
                element.addEventListener('touchstart', function(e) {
                    touchStartX = e.touches[0].clientX;
                    isSwiping = true;
                });
                
                element.addEventListener('touchmove', function(e) {
                    if (!isSwiping) return;
                    
                    touchEndX = e.touches[0].clientX;
                    const diff = touchStartX - touchEndX;
                    
                    if (diff > 0) {
                        // Swiping left (show actions)
                        this.style.transform = `translateX(-${Math.min(diff, 160)}px)`;
                        this.classList.add('swiping');
                    }
                });
                
                element.addEventListener('touchend', function() {
                    if (!isSwiping) return;
                    
                    const diff = touchStartX - touchEndX;
                    if (diff > 100) {
                        // Swipe complete - show actions
                        this.style.transform = 'translateX(-160px)';
                    } else {
                        // Swipe cancelled
                        this.style.transform = 'translateX(0)';
                        this.classList.remove('swiping');
                    }
                    
                    isSwiping = false;
                });
                
                // Click handlers for swipe actions
                const swipeActions = element.querySelector('.swipe-actions');
                if (swipeActions) {
                    swipeActions.querySelectorAll('.swipe-action').forEach(action => {
                        action.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const actionType = this.getAttribute('data-action');
                            
                            if (actionType === 'delete' && deleteCallback) {
                                deleteCallback();
                            } else if (actionType === 'edit' && editCallback) {
                                editCallback();
                            } else if (actionType === 'complete' && editCallback) {
                                editCallback();
                            }
                            
                            // Reset swipe
                            element.style.transform = 'translateX(0)';
                            element.classList.remove('swiping');
                        });
                    });
                }
            };
        }

        function setupPullToRefresh() {
            let pullStartY = 0;
            let pullDistance = 0;
            
            const dashboardPage = document.getElementById('dashboard');
            const refreshIndicator = dashboardPage.querySelector('.refresh-indicator');
            
            // Touch event handlers
            dashboardPage.addEventListener('touchstart', function(e) {
                if (window.scrollY === 0) {
                    pullStartY = e.touches[0].pageY;
                }
            });
            
            dashboardPage.addEventListener('touchmove', function(e) {
                if (!pullStartY || window.scrollY > 0) return;
                
                pullDistance = e.touches[0].pageY - pullStartY;
                if (pullDistance > 0) {
                    e.preventDefault();
                    refreshIndicator.style.top = Math.min(pullDistance, 60) + 'px';
                    
                    if (pullDistance > 100) {
                        refreshIndicator.classList.add('active');
                    }
                }
            });
            
            dashboardPage.addEventListener('touchend', function(e) {
                if (pullDistance > 100) {
                    refreshDashboard();
                }
                
                // Reset
                refreshIndicator.style.top = '-60px';
                refreshIndicator.classList.remove('active');
                pullStartY = 0;
                pullDistance = 0;
            });
            
            function refreshDashboard() {
                showToast('Refreshing data...', 'info');
                
                // Simulate data refresh
                setTimeout(() => {
                    updateDashboard();
                    updateStatisticsChart();
                    showToast('Data refreshed successfully!', 'success');
                }, 1000);
            }
        }

        function setupDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            // Check for saved theme preference
            if (appSettings.darkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
            
            // Toggle dark mode
            darkModeToggle.addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');
                
                if (document.body.classList.contains('dark-mode')) {
                    appSettings.darkMode = true;
                    this.innerHTML = '<i class="fas fa-sun"></i>';
                    showToast('Dark mode enabled', 'info');
                } else {
                    appSettings.darkMode = false;
                    this.innerHTML = '<i class="fas fa-moon"></i>';
                    showToast('Light mode enabled', 'info');
                }
                
                saveSettings();
            });
        }

        function setupEnhancedSignup() {
            // Congregation search
            const searchInput = document.getElementById('signupCongregation');
            const suggestions = document.getElementById('congregationSuggestions');
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                if (query.length >= 2) {
                    const filtered = congregationSuggestions.filter(cong => 
                        cong.toLowerCase().includes(query)
                    );
                    
                    suggestions.innerHTML = '';
                    
                    if (filtered.length > 0) {
                        filtered.forEach(cong => {
                            const item = document.createElement('div');
                            item.className = 'suggestion-item';
                            item.textContent = cong;
                            item.addEventListener('click', function() {
                                searchInput.value = cong;
                                suggestions.classList.remove('active');
                            });
                            suggestions.appendChild(item);
                        });
                        suggestions.classList.add('active');
                    }
                } else {
                    suggestions.classList.remove('active');
                }
            });
            
            // Profile picture upload
            const uploadBtn = document.getElementById('uploadProfilePicture');
            const fileInput = document.getElementById('profilePictureInput');
            const profilePreview = document.getElementById('profilePreview');
            
            uploadBtn.addEventListener('click', function() {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        showNotification('Image size should be less than 5MB', 'error');
                        return;
                    }
                    
                    if (!file.type.match('image.*')) {
                        showNotification('Please select an image file', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        userProfilePicture = e.target.result;
                        profilePreview.innerHTML = `<img src="${e.target.result}" alt="Profile Preview">`;
                        showToast('Profile picture uploaded successfully!', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Ministry type selection
            const ministryOptions = document.querySelectorAll('.ministry-type-option');
            const ministryTypeInput = document.getElementById('ministryType');
            
            ministryOptions.forEach(option => {
                option.addEventListener('click', function() {
                    ministryOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    ministryTypeInput.value = this.getAttribute('data-type');
                });
            });
            
            // Password strength
            const passwordInput = document.getElementById('signupPassword');
            const strengthIndicator = document.getElementById('passwordStrength');
            const strengthFill = document.getElementById('strengthFill');
            const strengthText = document.getElementById('strengthText');
            
            passwordInput.addEventListener('input', function() {
                const password = this.value;
                
                const hasLength = password.length >= 6;
                const hasUppercase = /[A-Z]/.test(password);
                const hasLowercase = /[a-z]/.test(password);
                const hasNumber = /[0-9]/.test(password);
                const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
                
                // Update criteria display
                updateCriteria('criteriaLength', hasLength);
                updateCriteria('criteriaUppercase', hasUppercase);
                updateCriteria('criteriaLowercase', hasLowercase);
                updateCriteria('criteriaNumber', hasNumber);
                updateCriteria('criteriaSpecial', hasSpecial);
                
                // Calculate strength
                let strength = 0;
                if (hasLength) strength += 20;
                if (hasUppercase) strength += 20;
                if (hasLowercase) strength += 20;
                if (hasNumber) strength += 20;
                if (hasSpecial) strength += 20;
                
                strengthFill.style.width = `${strength}%`;
                
                if (strength === 0) {
                    strengthIndicator.classList.remove('active');
                    strengthFill.style.backgroundColor = '#e9ecef';
                } else {
                    strengthIndicator.classList.add('active');
                    
                    if (strength < 40) {
                        strengthFill.style.backgroundColor = '#dc3545';
                        strengthText.textContent = 'Weak password';
                    } else if (strength < 80) {
                        strengthFill.style.backgroundColor = '#ffc107';
                        strengthText.textContent = 'Medium strength';
                    } else {
                        strengthFill.style.backgroundColor = '#28a745';
                        strengthText.textContent = 'Strong password';
                    }
                }
                
                // Check password match
                checkPasswordMatch();
            });
            
            function updateCriteria(elementId, met) {
                const element = document.getElementById(elementId);
                if (met) {
                    element.classList.remove('criteria-unmet');
                    element.classList.add('criteria-met');
                    element.querySelector('i').className = 'fas fa-check-circle';
                } else {
                    element.classList.remove('criteria-met');
                    element.classList.add('criteria-unmet');
                    element.querySelector('i').className = 'fas fa-times-circle';
                }
            }
            
            function checkPasswordMatch() {
                const password = document.getElementById('signupPassword').value;
                const confirmPassword = document.getElementById('signupConfirmPassword').value;
                const matchText = document.getElementById('passwordMatchText');
                
                if (confirmPassword) {
                    if (password === confirmPassword) {
                        matchText.textContent = 'Passwords match!';
                        matchText.style.color = '#28a745';
                    } else {
                        matchText.textContent = 'Passwords do not match';
                        matchText.style.color = '#dc3545';
                    }
                } else {
                    matchText.textContent = '';
                }
            }
            
            // Email validation
            const emailInput = document.getElementById('signupEmail');
            const validationText = document.getElementById('emailValidationText');
            
            emailInput.addEventListener('input', function() {
                const email = this.value.trim();
                
                if (!email) {
                    validationText.textContent = '';
                    return;
                }
                
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                if (!emailRegex.test(email)) {
                    validationText.textContent = 'Please enter a valid email address';
                    validationText.style.color = '#dc3545';
                } else {
                    const users = JSON.parse(localStorage.getItem('appUsers')) || [];
                    const existingUser = users.find(u => u.email.toLowerCase() === email.toLowerCase());
                    
                    if (existingUser) {
                        validationText.textContent = 'This email is already registered';
                        validationText.style.color = '#dc3545';
                    } else {
                        validationText.textContent = 'Email is available';
                        validationText.style.color = '#28a745';
                    }
                }
            });
            
            // Signup steps
            const steps = document.querySelectorAll('.signup-step');
            const stepIndicators = document.querySelectorAll('.signup-steps .step');
            
            document.querySelectorAll('.next-step').forEach(button => {
                button.addEventListener('click', function() {
                    const currentStep = parseInt(this.closest('.signup-step').getAttribute('data-step'));
                    const nextStep = parseInt(this.getAttribute('data-next'));
                    
                    if (validateStep(currentStep)) {
                        goToStep(nextStep);
                    }
                });
            });
            
            document.querySelectorAll('.prev-step').forEach(button => {
                button.addEventListener('click', function() {
                    const prevStep = parseInt(this.getAttribute('data-prev'));
                    goToStep(prevStep);
                });
            });
            
            function goToStep(stepNumber) {
                // Update step indicators
                stepIndicators.forEach(indicator => {
                    const indicatorStep = parseInt(indicator.getAttribute('data-step'));
                    indicator.classList.remove('active', 'completed');
                    
                    if (indicatorStep === stepNumber) {
                        indicator.classList.add('active');
                    } else if (indicatorStep < stepNumber) {
                        indicator.classList.add('completed');
                    }
                });
                
                // Update step content
                steps.forEach(step => {
                    const stepNum = parseInt(step.getAttribute('data-step'));
                    if (stepNum === stepNumber) {
                        step.classList.add('active');
                        step.style.display = 'block';
                        setTimeout(() => {
                            step.style.opacity = '1';
                            step.style.transform = 'translateY(0)';
                        }, 10);
                    } else {
                        step.classList.remove('active');
                        step.style.opacity = '0';
                        step.style.transform = 'translateY(20px)';
                        setTimeout(() => {
                            step.style.display = 'none';
                        }, 300);
                    }
                });
                
                signupStep = stepNumber;
            }
            
            function validateStep(step) {
                switch(step) {
                    case 1:
                        const name = document.getElementById('signupName').value.trim();
                        if (!name) {
                            showNotification('Please enter your full name', 'error');
                            return false;
                        }
                        return true;
                        
                    case 2:
                        const ministryType = document.getElementById('ministryType').value;
                        if (!ministryType) {
                            showNotification('Please select your ministry type', 'error');
                            return false;
                        }
                        return true;
                        
                    default:
                        return true;
                }
            }
        }

        function setupBiometricLogin() {
            const biometricBtn = document.getElementById('biometricLoginBtn');
            const biometricModal = document.getElementById('biometricModal');
            
            // Check if WebAuthn is supported
            if (!window.PublicKeyCredential) {
                biometricBtn.style.display = 'none';
                return;
            }
            
            biometricBtn.addEventListener('click', function() {
                biometricModal.style.display = 'flex';
            });
            
            // Close modal buttons
            document.getElementById('closeBiometricModal').addEventListener('click', function() {
                biometricModal.style.display = 'none';
            });
            
            document.getElementById('usePassword').addEventListener('click', function(e) {
                e.preventDefault();
                biometricModal.style.display = 'none';
            });
            
            // Biometric authentication
            document.getElementById('useBiometric').addEventListener('click', async function() {
                try {
                    showToast('Checking biometric credentials...', 'info');
                    
                    // Simulate biometric auth
                    setTimeout(() => {
                        const email = document.getElementById('loginEmail').value || 'demo@example.com';
                        const users = JSON.parse(localStorage.getItem('appUsers')) || [];
                        const user = users.find(u => u.email === email);
                        
                        if (user) {
                            currentUser = {
                                email: user.email,
                                name: user.name,
                                ministryType: user.ministryType,
                                monthlyGoal: user.monthlyGoal
                            };
                            
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            loadUserData();
                            showApp();
                            biometricModal.style.display = 'none';
                            showToast('Biometric login successful!', 'success');
                        } else {
                            showToast('No matching account found', 'error');
                        }
                    }, 1500);
                    
                } catch (error) {
                    showToast('Biometric authentication failed', 'error');
                }
            });
        }

        function setupEnhancedMaps() {
            // Map toolbar functionality
            document.getElementById('drawPolygon')?.addEventListener('click', function() {
                this.classList.toggle('active');
                if (this.classList.contains('active')) {
                    showToast('Click on map to draw polygon', 'info');
                }
            });
            
            document.getElementById('addMarker')?.addEventListener('click', function() {
                showToast('Click on map to add marker', 'info');
                if (studyMap) {
                    studyMap.once('click', function(e) {
                        if (studyMarker) {
                            studyMap.removeLayer(studyMarker);
                        }
                        studyMarker = L.marker(e.latlng).addTo(studyMap);
                        selectedStudyLocation = e.latlng;
                        studyMarker.bindPopup('Study Location').openPopup();
                    });
                }
            });
            
            document.getElementById('measureDistance')?.addEventListener('click', function() {
                this.classList.toggle('active');
                showToast('Measure tool ' + (this.classList.contains('active') ? 'enabled' : 'disabled'), 'info');
            });
            
            document.getElementById('fullscreenMap')?.addEventListener('click', function() {
                const mapContainer = document.getElementById('studyMap');
                if (!document.fullscreenElement) {
                    mapContainer.requestFullscreen().catch(err => {
                        showToast(`Error enabling fullscreen: ${err.message}`, 'error');
                    });
                } else {
                    document.exitFullscreen();
                }
            });
            
            document.getElementById('cacheMap')?.addEventListener('click', function() {
                if (!navigator.onLine) {
                    showToast('Cannot cache while offline', 'error');
                    return;
                }
                
                showToast('Caching map area for offline use...', 'info');
                setTimeout(() => {
                    showToast('Map area cached successfully!', 'success');
                }, 2000);
            });
        }

        function setupNotifications() {
            if (!('Notification' in window)) {
                console.log('This browser does not support notifications');
                return;
            }
            
            if (Notification.permission === 'default') {
                setTimeout(() => {
                    showModal('Enable Notifications', 
                        'Get reminders for Bible study follow-ups and ministry goals. Would you like to enable notifications?',
                        () => {
                            Notification.requestPermission().then(permission => {
                                if (permission === 'granted') {
                                    showToast('Notifications enabled!', 'success');
                                    scheduleReminderNotifications();
                                }
                            });
                        }
                    );
                }, 5000);
            }
            
            function scheduleReminderNotifications() {
                if (Notification.permission !== 'granted') return;
                
                // Schedule daily reminder check
                setInterval(() => {
                    const today = new Date();
                    const activeStudies = bibleStudies.filter(study => study.status === 'active');
                    
                    activeStudies.forEach(study => {
                        const lastConducted = getLastConductedDate(study.id);
                        if (lastConducted) {
                            const daysSince = Math.floor((today - lastConducted) / (1000 * 60 * 60 * 24));
                            if (daysSince >= 7) {
                                showToast(`Follow up with ${study.name}`, 'info');
                            }
                        }
                    });
                }, 1000 * 60 * 60); // Check hourly
            }
            
            // Request notification permission from Firebase if available
            if (firebaseMessaging && appSettings.enableNotifications) {
                firebaseMessaging.requestPermission()
                    .then(() => {
                        console.log('Notification permission granted.');
                        return firebaseMessaging.getToken();
                    })
                    .then((token) => {
                        console.log('FCM Token:', token);
                        // Save token to server/database
                    })
                    .catch((err) => {
                        console.log('Unable to get permission to notify.', err);
                    });
                
                // Handle incoming messages
                firebaseMessaging.onMessage((payload) => {
                    console.log('Message received:', payload);
                    showToast(payload.notification?.body || 'New notification', 'info');
                });
            }
        }

        function setupDataManagement() {
            // Enhanced backup with encryption
            document.getElementById('backupData').addEventListener('click', async function() {
                const backupData = {
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    user: currentUser,
                    reports: reports,
                    studies: bibleStudies,
                    settings: appSettings
                };
                
                // Encrypt backup
                const encrypted = await encryptData(JSON.stringify(backupData));
                const blob = new Blob([encrypted], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `ministry-backup-${new Date().toISOString().split('T')[0]}.encrypted`;
                a.click();
                
                showToast('Encrypted backup created', 'success');
            });
            
            // Restore data
            document.getElementById('restoreData').addEventListener('click', function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json,.encrypted';
                
                input.onchange = async e => { 
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = async (event) => {
                        try {
                            let backup;
                            if (file.name.endsWith('.encrypted')) {
                                const decrypted = await decryptData(event.target.result);
                                backup = JSON.parse(decrypted);
                            } else {
                                backup = JSON.parse(event.target.result);
                            }
                            
                            if (!backup.reports || !backup.studies || !backup.settings) {
                                throw new Error('Invalid backup file format');
                            }
                            
                            showModal('Restore Data', 'This will replace all your current data. Are you sure?', () => {
                                reports = backup.reports || [];
                                bibleStudies = backup.studies || [];
                                appSettings = backup.settings || {};
                                
                                saveUserData();
                                saveSettings();
                                updateDashboard();
                                updateStudiesList();
                                updateReportsList();
                                
                                showToast('Data restored successfully!', 'success');
                            });
                        } catch (error) {
                            showToast('Error restoring backup: ' + error.message, 'error');
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                input.click();
            });
            
            // Clear all data
            document.getElementById('clearAllData').addEventListener('click', function() {
                showModal('Clear All Data', 'This will permanently delete ALL your reports and Bible studies. This action cannot be undone. Are you sure?', () => {
                    reports = [];
                    bibleStudies = [];
                    studiesConductedToday.clear();
                    
                    saveUserData();
                    updateDashboard();
                    updateStudiesList();
                    updateReportsList();
                    
                    showToast('All data cleared successfully!', 'success');
                });
            });
            
            // Auto-backup every 24 hours
            setInterval(() => {
                if (navigator.onLine) {
                    autoBackup();
                }
            }, 24 * 60 * 60 * 1000);
            
            function autoBackup() {
                const lastBackup = localStorage.getItem('lastAutoBackup');
                const now = new Date();
                
                if (!lastBackup || (now - new Date(lastBackup)) > (24 * 60 * 60 * 1000)) {
                    localStorage.setItem('lastAutoBackup', now.toISOString());
                    console.log('Auto-backup completed');
                }
            }
        }

        function setupPWAFeatures() {
            let deferredPrompt;
            const installButton = document.getElementById('installButton');
            
            // Check if app is already installed
            if (window.matchMedia('(display-mode: standalone)').matches) {
                installButton.classList.add('hidden');
            }
            
            // Listen for beforeinstallprompt event
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installButton.classList.remove('hidden');
                
                installButton.addEventListener('click', () => {
                    installButton.classList.add('hidden');
                    deferredPrompt.prompt();
                    
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            showToast('App installed successfully!', 'success');
                        }
                        deferredPrompt = null;
                    });
                });
            });
            
            // Listen for app installed event
            window.addEventListener('appinstalled', () => {
                installButton.classList.add('hidden');
                deferredPrompt = null;
            });
            
            // Check for updates
            document.getElementById('updateApp')?.addEventListener('click', () => {
                window.location.reload();
            });
            
            // Register service worker
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    const swContent = `
                        // Service Worker for Ministry Report Book
                        const CACHE_NAME = 'ministry-report-v2';
                        const urlsToCache = [
                            '/',
                            '/index.html'
                        ];
                        
                        self.addEventListener('install', event => {
                            event.waitUntil(
                                caches.open(CACHE_NAME)
                                    .then(cache => {
                                        return cache.addAll(urlsToCache);
                                    })
                            );
                        });
                        
                        self.addEventListener('fetch', event => {
                            event.respondWith(
                                caches.match(event.request)
                                    .then(response => {
                                        if (response) {
                                            return response;
                                        }
                                        
                                        return fetch(event.request)
                                            .then(response => {
                                                if (!response || response.status !== 200 || response.type !== 'basic') {
                                                    return response;
                                                }
                                                
                                                const responseToCache = response.clone();
                                                caches.open(CACHE_NAME)
                                                    .then(cache => {
                                                        cache.put(event.request, responseToCache);
                                                    });
                                                
                                                return response;
                                            })
                                            .catch(() => {
                                                return caches.match('/');
                                            });
                                    })
                            );
                        });
                        
                        self.addEventListener('activate', event => {
                            event.waitUntil(
                                caches.keys().then(cacheNames => {
                                    return Promise.all(
                                        cacheNames.map(cacheName => {
                                            if (cacheName !== CACHE_NAME) {
                                                return caches.delete(cacheName);
                                            }
                                        })
                                    );
                                })
                            );
                        });
                    `;
                    
                    const blob = new Blob([swContent], { type: 'application/javascript' });
                    const swURL = URL.createObjectURL(blob);
                    
                    navigator.serviceWorker.register(swURL)
                        .then(registration => {
                            console.log('Service Worker registered');
                            
                            // Check for updates
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                if (newWorker) {
                                    newWorker.addEventListener('statechange', () => {
                                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                            document.getElementById('updateNotification').classList.add('show');
                                        }
                                    });
                                }
                            });
                        })
                        .catch(err => {
                            console.log('Service Worker registration failed:', err);
                        });
                });
            }
        }

        function setupErrorTracking() {
            window.onerror = function(message, source, lineno, colno, error) {
                console.error('Global error:', { message, source, lineno, colno, error });
                
                // Log error locally
                const errors = JSON.parse(localStorage.getItem('appErrors') || '[]');
                errors.push({
                    type: 'javascript',
                    message: message,
                    stack: error?.stack,
                    url: window.location.href,
                    user: currentUser?.email,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('appErrors', JSON.stringify(errors.slice(-100)));
                
                // Show user-friendly message
                showToast('An error occurred. The app will continue to work offline.', 'error');
                return true;
            };
            
            window.addEventListener('unhandledrejection', function(event) {
                console.error('Unhandled rejection:', event.reason);
                
                const errors = JSON.parse(localStorage.getItem('appErrors') || '[]');
                errors.push({
                    type: 'promise',
                    message: event.reason?.message || 'Unhandled promise rejection',
                    stack: event.reason?.stack,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('appErrors', JSON.stringify(errors.slice(-100)));
            });
        }

        async function setupEncryption() {
            // Simple encryption for demo (use Web Crypto API in production)
            window.encryptData = async function(data) {
                return btoa(unescape(encodeURIComponent(data)));
            };
            
            window.decryptData = async function(encrypted) {
                try {
                    return decodeURIComponent(escape(atob(encrypted)));
                } catch (error) {
                    console.error('Decryption error:', error);
                    return null;
                }
            };
        }

        function setupPrivacyPolicy() {
            // Show privacy policy on first use
            const hasAccepted = localStorage.getItem('acceptedPrivacyPolicy');
            if (!hasAccepted && currentUser) {
                setTimeout(() => {
                    document.getElementById('privacyPolicyModal').style.display = 'flex';
                }, 5000);
            }
            
            document.getElementById('acceptPrivacyPolicy')?.addEventListener('click', function() {
                localStorage.setItem('acceptedPrivacyPolicy', 'true');
                document.getElementById('privacyPolicyModal').style.display = 'none';
                showToast('Thank you for reviewing our privacy policy', 'success');
            });
            
            document.getElementById('closePrivacyModal')?.addEventListener('click', function() {
                document.getElementById('privacyPolicyModal').style.display = 'none';
            });
        }

        function setupCloudSync() {
            const syncStatus = document.getElementById('syncStatus');
            
            function updateSyncStatus() {
                if (navigator.onLine) {
                    syncStatus.innerHTML = '<i class="fas fa-cloud"></i> Online';
                    syncStatus.classList.remove('error');
                    processOfflineQueue();
                } else {
                    syncStatus.innerHTML = '<i class="fas fa-cloud-slash"></i> Offline';
                    syncStatus.classList.add('error');
                }
            }
            
            async function processOfflineQueue() {
                if (isSyncing || offlineQueue.length === 0 || !appSettings.enableCloudSync) return;
                
                isSyncing = true;
                syncStatus.classList.add('syncing');
                syncStatus.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Syncing...';
                
                for (const operation of offlineQueue) {
                    try {
                        await syncOperation(operation);
                    } catch (error) {
                        console.error('Sync failed:', error);
                    }
                }
                
                offlineQueue = offlineQueue.filter(op => !op.completed);
                isSyncing = false;
                syncStatus.classList.remove('syncing');
                updateSyncStatus();
                
                if (offlineQueue.length === 0) {
                    showToast('All data synced to cloud', 'success');
                }
            }
            
            async function syncOperation(operation) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        console.log('Syncing:', operation);
                        resolve();
                    }, 1000);
                });
            }
            
            window.queueSync = function(operation) {
                if (!appSettings.enableCloudSync) return;
                
                offlineQueue.push({
                    ...operation,
                    timestamp: new Date().toISOString(),
                    userId: currentUser?.email
                });
                
                if (!navigator.onLine) {
                    showToast('Operation queued for sync', 'info');
                }
                
                localStorage.setItem('syncQueue', JSON.stringify(offlineQueue));
            };
            
            // Load offline queue
            const savedQueue = localStorage.getItem('syncQueue');
            if (savedQueue) {
                offlineQueue = JSON.parse(savedQueue);
            }
            
            updateSyncStatus();
            window.addEventListener('online', updateSyncStatus);
            window.addEventListener('offline', updateSyncStatus);
            
            // Auto-sync every 5 minutes
            setInterval(() => {
                if (navigator.onLine && offlineQueue.length > 0 && appSettings.enableCloudSync) {
                    processOfflineQueue();
                }
            }, 5 * 60 * 1000);
        }

        function setupOfflineDetection() {
            const offlineStatus = document.getElementById('offlineStatus');
            
            if (!navigator.onLine) {
                offlineStatus.classList.remove('hidden');
            }
            
            window.addEventListener('online', () => {
                offlineStatus.classList.add('hidden');
                showToast('You are back online!', 'success');
            });
            
            window.addEventListener('offline', () => {
                offlineStatus.classList.remove('hidden');
                showToast('You are currently offline', 'warning');
            });
        }

        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================

        function initializeAuth() {
            const loggedInUser = localStorage.getItem('currentUser');
            if (loggedInUser) {
                try {
                    currentUser = JSON.parse(loggedInUser);
                    loadUserData();
                    showApp();
                } catch (e) {
                    localStorage.removeItem('currentUser');
                    showAuth();
                }
            } else {
                showAuth();
            }
        }

        function showAuth() {
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('appContainer').classList.add('active');
            
            // Update user info
            if (currentUser) {
                const ministryTypes = {
                    'publisher': 'Publisher',
                    'regular-pioneer': 'Regular Pioneer',
                    'special-pioneer': 'Special Pioneer',
                    'elder': 'Elder',
                    'ministerial-servant': 'Ministerial Servant',
                    'other': 'Minister'
                };
                
                const ministryType = currentUser.ministryType || 'publisher';
                document.getElementById('userInfo').innerHTML = 
                    `<i class="fas fa-user-circle"></i> ${currentUser.name} ‚Ä¢ ${ministryTypes[ministryType] || 'Publisher'}`;
            }
            
            initializeApp();
        }

        function loadUserData() {
            if (!currentUser) return;
            
            const userKey = `user_${currentUser.email}`;
            const userData = JSON.parse(localStorage.getItem(userKey)) || {};
            
            reports = userData.reports || [];
            bibleStudies = userData.bibleStudies || [];
        }

        function saveUserData() {
            if (!currentUser) return;
            
            const userKey = `user_${currentUser.email}`;
            const userData = {
                reports: reports,
                bibleStudies: bibleStudies,
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem(userKey, JSON.stringify(userData));
            
            // Queue for cloud sync
            if (appSettings.enableCloudSync) {
                queueSync({
                    type: 'userData',
                    data: userData
                });
            }
        }

        function setupAuthEventListeners() {
            // Auth tabs
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const formId = tab.getAttribute('data-form');
                    document.getElementById(formId + 'Form').classList.add('active');
                });
            });
            
            // Switch between login and signup
            document.getElementById('switchToSignup').addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelector('.auth-tab[data-form="signup"]').click();
            });
            
            document.getElementById('switchToLogin').addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelector('.auth-tab[data-form="login"]').click();
            });
            
            // Login form
            document.getElementById('loginFormElement').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                // Try Firebase auth first
                if (firebaseAuth) {
                    firebaseAuth.signInWithEmailAndPassword(email, password)
                        .then((userCredential) => {
                            const user = userCredential.user;
                            currentUser = {
                                email: user.email,
                                name: user.displayName || email.split('@')[0],
                                uid: user.uid
                            };
                            
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            loadUserDataFromFirestore();
                            showApp();
                            showToast('Login successful!', 'success');
                        })
                        .catch((error) => {
                            // Fallback to local storage
                            const user = users.find(u => u.email === email && u.password === password);
                            
                            if (user) {
                                currentUser = {
                                    email: user.email,
                                    name: user.name,
                                    ministryType: user.ministryType,
                                    monthlyGoal: user.monthlyGoal
                                };
                                
                                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                                loadUserData();
                                showApp();
                                showToast('Login successful!', 'success');
                            } else {
                                showNotification('Invalid email or password', 'error');
                            }
                        });
                } else {
                    // Local storage only
                    const user = users.find(u => u.email === email && u.password === password);
                    
                    if (user) {
                        currentUser = {
                            email: user.email,
                            name: user.name,
                            ministryType: user.ministryType,
                            monthlyGoal: user.monthlyGoal
                        };
                        
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        loadUserData();
                        showApp();
                        showToast('Login successful!', 'success');
                    } else {
                        showNotification('Invalid email or password', 'error');
                    }
                }
            });
            
            // Signup form
            document.getElementById('signupFormElement').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const userData = {
                    name: document.getElementById('signupName').value.trim(),
                    email: document.getElementById('signupEmail').value.trim().toLowerCase(),
                    password: document.getElementById('signupPassword').value,
                    confirmPassword: document.getElementById('signupConfirmPassword').value,
                    phone: document.getElementById('signupPhone').value.trim(),
                    language: document.getElementById('signupLanguage').value,
                    congregation: document.getElementById('signupCongregation').value.trim(),
                    ministryType: document.getElementById('ministryType').value,
                    yearsInMinistry: document.getElementById('yearsInMinistry').value,
                    monthlyGoal: parseInt(document.getElementById('monthlyGoalInitial').value) || 50,
                    profilePicture: userProfilePicture,
                    agreedTerms: document.getElementById('agreeTerms').checked,
                    createdAt: new Date().toISOString()
                };
                
                // Validation
                if (!validateEnhancedSignup(userData)) {
                    return;
                }
                
                // Check if user already exists
                const existingUser = users.find(u => u.email.toLowerCase() === userData.email.toLowerCase());
                if (existingUser) {
                    showNotification('User already exists with this email', 'error');
                    return;
                }
                
                // Create new user
                const newUser = {
                    name: userData.name,
                    email: userData.email,
                    password: userData.password,
                    phone: userData.phone,
                    language: userData.language,
                    congregation: userData.congregation,
                    ministryType: userData.ministryType,
                    yearsInMinistry: userData.yearsInMinistry,
                    monthlyGoal: userData.monthlyGoal,
                    profilePicture: userData.profilePicture,
                    createdAt: userData.createdAt
                };
                
                users.push(newUser);
                localStorage.setItem('appUsers', JSON.stringify(users));
                
                // Try Firebase registration
                if (firebaseAuth) {
                    firebaseAuth.createUserWithEmailAndPassword(userData.email, userData.password)
                        .then((userCredential) => {
                            const user = userCredential.user;
                            // Save additional user data to Firestore
                            return firestore.collection('users').doc(user.uid).set({
                                name: userData.name,
                                email: userData.email,
                                ministryType: userData.ministryType,
                                monthlyGoal: userData.monthlyGoal,
                                createdAt: new Date().toISOString()
                            });
                        })
                        .catch((error) => {
                            console.log('Firebase registration failed, using local storage only:', error);
                        });
                }
                
                // Auto login
                currentUser = {
                    email: newUser.email,
                    name: newUser.name,
                    ministryType: newUser.ministryType,
                    monthlyGoal: newUser.monthlyGoal
                };
                
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Initialize user data
                appSettings.monthlyGoal = userData.monthlyGoal;
                appSettings.userName = userData.name;
                saveSettings();
                
                showApp();
                showToast('Account created successfully! Welcome to the ministry!', 'success');
                
                // Reset signup form
                e.target.reset();
                userProfilePicture = null;
                document.getElementById('profilePreview').innerHTML = '<i class="fas fa-user-circle" style="font-size: 4rem; color: #0057a3;"></i>';
                goToStep(1);
            });
            
            // Forgot password
            document.getElementById('forgotPassword').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('forgotPasswordModal').style.display = 'flex';
            });
            
            document.getElementById('closeForgotPasswordModal').addEventListener('click', function() {
                document.getElementById('forgotPasswordModal').style.display = 'none';
            });
            
            document.getElementById('backToLogin').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('forgotPasswordModal').style.display = 'none';
                document.querySelector('.auth-tab[data-form="login"]').click();
            });
            
            document.getElementById('forgotPasswordForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('resetEmail').value.trim();
                
                if (firebaseAuth) {
                    firebaseAuth.sendPasswordResetEmail(email)
                        .then(() => {
                            showToast(`Password reset instructions sent to ${email}`, 'success');
                            document.getElementById('forgotPasswordModal').style.display = 'none';
                            document.getElementById('resetEmail').value = '';
                        })
                        .catch((error) => {
                            showToast('Error sending reset email', 'error');
                        });
                } else {
                    const users = JSON.parse(localStorage.getItem('appUsers')) || [];
                    const user = users.find(u => u.email.toLowerCase() === email.toLowerCase());
                    
                    if (user) {
                        showToast(`Password reset instructions sent to ${email}`, 'success');
                        document.getElementById('forgotPasswordModal').style.display = 'none';
                        document.getElementById('resetEmail').value = '';
                    } else {
                        showToast('No account found with this email', 'error');
                    }
                }
            });
            
            // Logout button
            document.getElementById('logoutButton').addEventListener('click', () => {
                saveUserData();
                saveSettings();
                
                if (firebaseAuth) {
                    firebaseAuth.signOut();
                }
                
                currentUser = null;
                localStorage.removeItem('currentUser');
                showAuth();
                showToast('Logged out successfully', 'info');
            });
            
            // Password toggle
            document.querySelectorAll('.password-toggle').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const input = this.parentElement.querySelector('input');
                    const icon = this.querySelector('i');
                    
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.className = 'fas fa-eye-slash';
                    } else {
                        input.type = 'password';
                        icon.className = 'fas fa-eye';
                    }
                });
            });
        }

        function loadUserDataFromFirestore() {
            if (!firestore || !currentUser?.uid) return;
            
            firestore.collection('users').doc(currentUser.uid).collection('reports').get()
                .then((querySnapshot) => {
                    reports = [];
                    querySnapshot.forEach((doc) => {
                        reports.push(doc.data());
                    });
                })
                .catch((error) => {
                    console.log('Error loading reports from Firestore:', error);
                });
            
            firestore.collection('users').doc(currentUser.uid).collection('studies').get()
                .then((querySnapshot) => {
                    bibleStudies = [];
                    querySnapshot.forEach((doc) => {
                        bibleStudies.push(doc.data());
                    });
                })
                .catch((error) => {
                    console.log('Error loading studies from Firestore:', error);
                });
        }

        function validateEnhancedSignup(userData) {
            if (!userData.name) {
                showNotification('Please enter your full name', 'error');
                goToStep(1);
                return false;
            }
            
            if (!userData.email) {
                showNotification('Please enter your email', 'error');
                goToStep(3);
                return false;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(userData.email)) {
                showNotification('Please enter a valid email address', 'error');
                goToStep(3);
                return false;
            }
            
            if (!userData.password) {
                showNotification('Please create a password', 'error');
                goToStep(3);
                return false;
            }
            
            if (userData.password.length < 6) {
                showNotification('Password must be at least 6 characters', 'error');
                goToStep(3);
                return false;
            }
            
            if (userData.password !== userData.confirmPassword) {
                showNotification('Passwords do not match', 'error');
                goToStep(3);
                return false;
            }
            
            if (!userData.agreedTerms) {
                showNotification('You must agree to the terms and conditions', 'error');
                goToStep(3);
                return false;
            }
            
            return true;
        }

        // ============================================
        // APP EVENT HANDLERS
        // ============================================

        function setupAppEventListeners() {
            // Tab navigation
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const pageId = tab.getAttribute('data-page');
                    document.getElementById(pageId).classList.add('active');
                    
                    // Initialize map if on bible studies page
                    if (pageId === 'bible-studies' && !studyMap) {
                        setTimeout(() => {
                            initStudyMap();
                        }, 300);
                    }
                    
                    // Reset studies conducted today when switching pages
                    studiesConductedToday.clear();
                    if (pageId === 'report') {
                        updateBibleStudiesChecklist();
                    }
                });
            });
            
            // Add Report form
            document.getElementById('reportForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const selectedStudies = Array.from(studiesConductedToday);
                
                const report = {
                    id: Date.now().toString(),
                    date: document.getElementById('reportDate').value,
                    hours: parseFloat(document.getElementById('hours').value) || 0,
                    bibleStudies: selectedStudies,
                    notes: document.getElementById('notes').value,
                    createdAt: new Date().toISOString()
                };
                
                reports.push(report);
                saveUserData();
                updateDashboard();
                updateReportsList();
                
                // Queue for cloud sync
                queueSync({
                    type: 'report',
                    action: 'add',
                    data: report
                });
                
                // Clear form
                e.target.reset();
                document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
                studiesConductedToday.clear();
                updateBibleStudiesChecklist();
                
                // Reset timer
                resetTimer();
                
                showToast('Report saved successfully!', 'success');
            });
            
            // Clear report form
            document.getElementById('clearReportForm').addEventListener('click', () => {
                document.getElementById('reportForm').reset();
                document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
                studiesConductedToday.clear();
                updateBibleStudiesChecklist();
                resetTimer();
            });
            
            // Timer controls
            document.getElementById('startTimer').addEventListener('click', startTimer);
            document.getElementById('pauseTimer').addEventListener('click', pauseTimer);
            document.getElementById('saveTimer').addEventListener('click', saveTimer);
            
            // Bible Study form
            document.getElementById('studyForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const study = {
                    id: Date.now().toString(),
                    name: document.getElementById('studyName').value,
                    address: document.getElementById('studyAddress').value,
                    phone: document.getElementById('studyPhone').value,
                    startDate: document.getElementById('studyStartDate').value,
                    location: selectedStudyLocation,
                    notes: document.getElementById('studyNotes').value,
                    status: 'active',
                    createdAt: new Date().toISOString()
                };
                
                bibleStudies.push(study);
                saveUserData();
                updateStudiesList();
                updateDashboard();
                
                // Queue for cloud sync
                queueSync({
                    type: 'study',
                    action: 'add',
                    data: study
                });
                
                // Clear form
                e.target.reset();
                document.getElementById('studyStartDate').value = new Date().toISOString().split('T')[0];
                selectedStudyLocation = null;
                
                // Clear marker
                if (studyMarker) {
                    studyMap.removeLayer(studyMarker);
                    studyMarker = null;
                }
                
                showToast('Bible study added successfully!', 'success');
            });
            
            // Map controls
            document.getElementById('locateAddress')?.addEventListener('click', () => {
                const address = document.getElementById('studyAddress').value;
                if (address.trim()) {
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.length > 0) {
                                const lat = parseFloat(data[0].lat);
                                const lon = parseFloat(data[0].lon);
                                const latlng = L.latLng(lat, lon);
                                studyMap.setView(latlng, 16);
                                placeMarker(latlng);
                                showToast('Location found!', 'success');
                            } else {
                                showToast('Address not found', 'error');
                            }
                        })
                        .catch(() => {
                            showToast('Error searching address. Please try again.', 'error');
                        });
                } else {
                    showToast('Please enter an address first', 'warning');
                }
            });
            
            document.getElementById('saveLocation')?.addEventListener('click', () => {
                if (studyMarker) {
                    showToast('Location saved!', 'success');
                } else {
                    showToast('Please select a location on the map first', 'warning');
                }
            });
            
            // Report filter
            document.getElementById('reportFilter').addEventListener('change', updateReportsList);
            
            // Export reports
            document.getElementById('exportReports').addEventListener('click', exportReports);
            
            // Settings form
            document.getElementById('settingsForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                appSettings.userName = document.getElementById('userName').value;
                appSettings.monthlyGoal = parseInt(document.getElementById('monthlyGoal').value) || 50;
                appSettings.enableReminders = document.getElementById('enableReminders').checked;
                appSettings.reminderDays = parseInt(document.getElementById('reminderDays').value) || 7;
                appSettings.enableCloudSync = document.getElementById('enableCloudSync').checked;
                appSettings.enableNotifications = document.getElementById('enableNotifications').checked;
                
                saveSettings();
                updateDashboard();
                
                // Setup notifications if enabled
                if (appSettings.enableNotifications) {
                    setupNotifications();
                }
                
                showToast('Settings saved successfully!', 'success');
            });
            
            // Refresh stats
            document.getElementById('refreshStats').addEventListener('click', updateStatisticsChart);
            
            // Pioneer goal calculator
            document.getElementById('calculatePioneer').addEventListener('click', calculateWeeklySchedule);
            
            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        window.showToast = function(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        };

        function showModal(title, message, confirmCallback) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('confirmationModal').style.display = 'flex';
            
            const confirmBtn = document.getElementById('modalConfirm');
            const cancelBtn = document.getElementById('modalCancel');
            
            function closeModal() {
                document.getElementById('confirmationModal').style.display = 'none';
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', closeModal);
                document.getElementById('closeModal').removeEventListener('click', closeModal);
            }
            
            function confirmHandler() {
                if (confirmCallback) confirmCallback();
                closeModal();
            }
            
            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', closeModal);
            document.getElementById('closeModal').addEventListener('click', closeModal);
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function getCurrentMonthName() {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            const now = new Date();
            return months[now.getMonth()];
        }

        // ============================================
        // TIMER FUNCTIONS
        // ============================================

        function startTimer() {
            if (!isTimerRunning) {
                isTimerRunning = true;
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    document.getElementById('timerDisplay').textContent = formatTime(timerSeconds);
                }, 1000);
                
                document.getElementById('startTimer').disabled = true;
                document.getElementById('pauseTimer').disabled = false;
                document.getElementById('saveTimer').disabled = false;
                
                showToast('Timer started', 'info');
            }
        }

        function pauseTimer() {
            if (isTimerRunning) {
                isTimerRunning = false;
                clearInterval(timerInterval);
                
                document.getElementById('startTimer').disabled = false;
                document.getElementById('pauseTimer').disabled = true;
                
                showToast('Timer paused', 'warning');
            }
        }

        function saveTimer() {
            const hours = timerSeconds / 3600;
            document.getElementById('hours').value = hours.toFixed(2);
            
            showToast(`Timer saved: ${hours.toFixed(2)} hours`, 'success');
            resetTimer();
        }

        function resetTimer() {
            pauseTimer();
            timerSeconds = 0;
            document.getElementById('timerDisplay').textContent = formatTime(timerSeconds);
            document.getElementById('startTimer').disabled = false;
            document.getElementById('pauseTimer').disabled = true;
            document.getElementById('saveTimer').disabled = true;
        }

        // ============================================
        // BIBLE STUDY FUNCTIONS
        // ============================================

        window.editStudy = function(studyId) {
            const study = bibleStudies.find(s => s.id === studyId);
            if (!study) return;
            
            // Fill form with study data
            document.getElementById('studyName').value = study.name;
            document.getElementById('studyAddress').value = study.address || '';
            document.getElementById('studyPhone').value = study.phone || '';
            document.getElementById('studyStartDate').value = study.startDate;
            document.getElementById('studyNotes').value = study.notes || '';
            
            // If study has location, show on map
            if (study.location && studyMap) {
                const latlng = L.latLng(study.location.lat, study.location.lng);
                studyMap.setView(latlng, 16);
                placeMarker(latlng);
                selectedStudyLocation = study.location;
            }
            
            // Switch to bible studies page and focus on form
            document.querySelector('.tab[data-page="bible-studies"]').click();
            document.getElementById('studyName').focus();
            
            // Remove the study (will be re-added when form is submitted)
            bibleStudies = bibleStudies.filter(s => s.id !== studyId);
            saveUserData();
            
            showToast('Editing study. Update the fields and click "Add Study" to save changes.', 'info');
        };

        window.deleteStudy = function(studyId) {
            showModal('Delete Bible Study', 'Are you sure you want to delete this Bible study? This action cannot be undone.', () => {
                bibleStudies = bibleStudies.filter(s => s.id !== studyId);
                saveUserData();
                updateStudiesList();
                updateDashboard();
                
                // Queue for cloud sync
                queueSync({
                    type: 'study',
                    action: 'delete',
                    data: { id: studyId }
                });
                
                showToast('Bible study deleted', 'success');
            });
        };

        window.markStudyComplete = function(studyId) {
            studiesConductedToday.add(studyId);
            updateBibleStudiesChecklist();
            updateFollowUpReminders();
            showToast(`Study marked for today's report`, 'success');
        };

        // ============================================
        // REPORT FUNCTIONS
        // ============================================

        window.deleteReport = function(reportId) {
            showModal('Delete Report', 'Are you sure you want to delete this report? This action cannot be undone.', () => {
                reports = reports.filter(r => r.id !== reportId);
                saveUserData();
                updateDashboard();
                updateReportsList();
                
                // Queue for cloud sync
                queueSync({
                    type: 'report',
                    action: 'delete',
                    data: { id: reportId }
                });
                
                showToast('Report deleted', 'success');
            });
        };

        function updateReportFilterOptions() {
            const filterSelect = document.getElementById('reportFilter');
            const existingOptions = Array.from(filterSelect.options).map(opt => opt.value);
            
            // Get unique months from reports
            const monthSet = new Set();
            reports.forEach(report => {
                const date = new Date(report.date);
                const monthYear = `${date.getFullYear()}-${date.getMonth()}`;
                monthSet.add(monthYear);
            });
            
            // Add month options
            monthSet.forEach(monthYear => {
                const [year, month] = monthYear.split('-');
                const monthName = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                const optionValue = `month-${monthYear}`;
                
                if (!existingOptions.includes(optionValue)) {
                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = monthName;
                    filterSelect.appendChild(option);
                }
            });
        }

        function updateReportSummary(reports) {
            const summaryDiv = document.getElementById('reportSummary');
            
            const totalHours = reports.reduce((sum, report) => sum + (parseFloat(report.hours) || 0), 0);
            const totalReports = reports.length;
            
            // Count unique bible studies
            const uniqueStudies = new Set();
            reports.forEach(report => {
                if (report.bibleStudies && Array.isArray(report.bibleStudies)) {
                    report.bibleStudies.forEach(studyId => {
                        uniqueStudies.add(studyId);
                    });
                }
            });
            
            summaryDiv.innerHTML = `
                <div class="stat-box">
                    <div class="stat-value">${totalHours.toFixed(1)}</div>
                    <div class="stat-label">Total Hours</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${totalReports}</div>
                    <div class="stat-label">Reports</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${uniqueStudies.size}</div>
                    <div class="stat-label">Studies Conducted</div>
                </div>
            `;
        }

        function exportReports() {
            const data = {
                user: currentUser,
                reports: reports,
                bibleStudies: bibleStudies,
                settings: appSettings,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `ministry-reports-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('Reports exported successfully!', 'success');
        }

        function calculateWeeklySchedule() {
            const goal = appSettings.monthlyGoal || 50;
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Filter reports for current month
            const monthReports = reports.filter(report => {
                const reportDate = new Date(report.date);
                return reportDate.getMonth() === currentMonth && 
                       reportDate.getFullYear() === currentYear;
            });
            
            const completedHours = monthReports.reduce((sum, report) => sum + (parseFloat(report.hours) || 0), 0);
            const remainingHours = Math.max(0, goal - completedHours);
            
            // Calculate days remaining in month
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const today = now.getDate();
            const daysRemaining = daysInMonth - today + 1;
            
            // Calculate weeks remaining
            const weeksRemaining = Math.ceil(daysRemaining / 7);
            
            // Calculate required hours per week
            const weeklyHours = weeksRemaining > 0 ? (remainingHours / weeksRemaining).toFixed(1) : remainingHours.toFixed(1);
            
            // Calculate recommended daily hours (assuming 5 days of ministry per week)
            const dailyHours = (weeklyHours / 5).toFixed(1);
            
            // Update calculator result
            document.getElementById('weeklyHours').textContent = `${weeklyHours} hours`;
            document.getElementById('daysRemaining').textContent = daysRemaining;
            document.getElementById('weeksRemaining').textContent = weeksRemaining;
            document.getElementById('dailyHours').textContent = `${dailyHours} hours`;
            document.getElementById('calculatorResult').style.display = 'block';
            
            showToast(`Weekly target: ${weeklyHours} hours for ${weeksRemaining} weeks`, 'info');
        }

        function showMonthSummary(monthIndex) {
            const now = new Date();
            const monthName = new Date(now.getFullYear(), monthIndex).toLocaleDateString('en-US', { month: 'long' });
            const monthReports = reports.filter(report => {
                const reportDate = new Date(report.date);
                return reportDate.getMonth() === monthIndex && 
                       reportDate.getFullYear() === now.getFullYear();
            });
            
            const totalHours = monthReports.reduce((sum, report) => sum + (parseFloat(report.hours) || 0), 0);
            const totalDays = new Set(monthReports.map(r => r.date)).size;
            
            // Count unique studies
            const uniqueStudies = new Set();
            monthReports.forEach(report => {
                if (report.bibleStudies && Array.isArray(report.bibleStudies)) {
                    report.bibleStudies.forEach(studyId => {
                        uniqueStudies.add(studyId);
                    });
                }
            });
            
            const summaryContent = document.getElementById('summaryContent');
            summaryContent.innerHTML = `
                <h3>${monthName} ${now.getFullYear()} Summary</h3>
                <div class="stats" style="margin: 20px 0;">
                    <div class="stat-box">
                        <div class="stat-value">${totalHours.toFixed(1)}</div>
                        <div class="stat-label">Total Hours</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${monthReports.length}</div>
                        <div class="stat-label">Reports</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${totalDays}</div>
                        <div class="stat-label">Days Worked</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${uniqueStudies.size}</div>
                        <div class="stat-label">Studies</div>
                    </div>
                </div>
                
                <h4>Daily Breakdown</h4>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${monthReports.length > 0 ? `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 10px; text-align: left;">Date</th>
                                    <th style="padding: 10px; text-align: left;">Hours</th>
                                    <th style="padding: 10px; text-align: left;">Studies</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${monthReports.map(report => {
                                    const studyNames = [];
                                    if (report.bibleStudies && Array.isArray(report.bibleStudies)) {
                                        report.bibleStudies.forEach(studyId => {
                                            const study = bibleStudies.find(s => s.id === studyId);
                                            if (study) studyNames.push(study.name);
                                        });
                                    }
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid #dee2e6;">
                                            <td style="padding: 10px;">${new Date(report.date).toLocaleDateString()}</td>
                                            <td style="padding: 10px;">${parseFloat(report.hours).toFixed(1)}</td>
                                            <td style="padding: 10px;">${studyNames.join(', ') || 'None'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    ` : '<p style="text-align: center; color: #666; padding: 20px;">No reports for this month</p>'}
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-info" onclick="exportMonthReports(${monthIndex})">
                        <i class="fas fa-download"></i> Export ${monthName} Reports
                    </button>
                </div>
            `;
            
            document.getElementById('summaryModal').style.display = 'flex';
        }

        window.exportMonthReports = function(monthIndex) {
            const now = new Date();
            const monthName = new Date(now.getFullYear(), monthIndex).toLocaleDateString('en-US', { month: 'long' });
            
            const monthReports = reports.filter(report => {
                const reportDate = new Date(report.date);
                return reportDate.getMonth() === monthIndex && 
                       reportDate.getFullYear() === now.getFullYear();
            });
            
            const data = {
                month: monthName,
                year: now.getFullYear(),
                reports: monthReports,
                summary: {
                    totalHours: monthReports.reduce((sum, report) => sum + (parseFloat(report.hours) || 0), 0),
                    totalReports: monthReports.length,
                    uniqueStudies: new Set(monthReports.flatMap(r => r.bibleStudies || [])).size
                },
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `${monthName.toLowerCase()}-${now.getFullYear()}-reports.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        };

        function getLastConductedDate(studyId) {
            const studyReports = reports
                .filter(report => report.bibleStudies?.includes(studyId))
                .map(report => new Date(report.date))
                .sort((a, b) => b - a);
            
            return studyReports[0] || null;
        }

        // ============================================
        // MAP FUNCTIONS
        // ============================================

        function initStudyMap() {
            if (!studyMap) {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            initMapWithPosition(position.coords.latitude, position.coords.longitude);
                        },
                        () => {
                            initMapWithPosition(40.7128, -74.0060);
                        },
                        { enableHighAccuracy: true, timeout: 5000 }
                    );
                } else {
                    initMapWithPosition(40.7128, -74.0060);
                }
            }
        }

        function initMapWithPosition(lat, lng) {
            studyMap = L.map('studyMap').setView([lat, lng], 13);
            
            // Add OpenStreetMap layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(studyMap);
            
            // Initialize geocoder
            const geocoder = L.Control.geocoder({
                defaultMarkGeocode: false,
                position: 'topleft'
            }).on('markgeocode', function(e) {
                const latlng = e.geocode.center;
                studyMap.setView(latlng, 16);
                document.getElementById('studyAddress').value = e.geocode.name;
                placeMarker(latlng);
            }).addTo(studyMap);
            
            // Add fullscreen control
            L.control.fullscreen().addTo(studyMap);
            
            // Add measure control
            L.control.measure({
                primaryLengthUnit: 'meters',
                secondaryLengthUnit: 'kilometers',
                primaryAreaUnit: 'sqmeters',
                secondaryAreaUnit: 'hectares'
            }).addTo(studyMap);
            
            // Add click event to map
            studyMap.on('click', function(e) {
                placeMarker(e.latlng);
            });
            
            // Load existing study markers
            loadStudyMarkers();
        }

        function placeMarker(latlng) {
            if (studyMarker) {
                studyMap.removeLayer(studyMarker);
            }
            
            studyMarker = L.marker(latlng, {
                icon: L.icon({
                    iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34]
                })
            }).addTo(studyMap);
            
            selectedStudyLocation = {
                lat: latlng.lat,
                lng: latlng.lng
            };
            
            studyMarker.bindPopup('Bible Study Location<br>Click "Save Location" to confirm').openPopup();
        }

        function loadStudyMarkers() {
            if (!studyMap) return;
            
            // Clear existing markers
            studyMap.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    studyMap.removeLayer(layer);
                }
            });
            
            // Add markers for all studies with locations
            bibleStudies.forEach(study => {
                if (study.location) {
                    const marker = L.marker([study.location.lat, study.location.lng]).addTo(studyMap);
                    marker.bindPopup(`
                        <strong>${study.name}</strong><br>
                        ${study.address || ''}<br>
                        ${study.phone || ''}<br>
                        Status: ${study.status}
                    `);
                }
            });
        }

        // ============================================
        // MANIFEST GENERATION
        // ============================================

        function generateManifest() {
            const manifest = {
                "name": "Ministry Report Book",
                "short_name": "Ministry App",
                "description": "Track and manage your ministry activity - For Jehovah's Witnesses",
                "start_url": "/",
                "display": "standalone",
                "background_color": "#0057a3",
                "theme_color": "#0057a3",
                "orientation": "portrait",
                "scope": "/",
                "icons": [
                    {
                        "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDI1NiAyNTYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTEyOCAwQzU3LjMgMCAwIDU3LjMgMCAxMjhzNTcuMyAxMjggMTI4IDEyOCAxMjgtNTcuMyAxMjgtMTI4UzE5OC43IDAgMTI4IDB6bTAgMjQwYy02MS44IDAtMTEyLTUwLjItMTEyLTExMlM2Ni4yIDE2IDEyOCAxNnMxMTIgNTAuMiAxMTIgMTEyLTUwLjIgMTEyLTExMiAxMTJ6IiBmaWxsPSIjZmZmIi8+PHBhdGggZD0iTTE0NCA2NEgxMTJjLTguOCAwLTE2IDcuMi0xNiAxNnY5NmMwIDguOCA3LjIgMTYgMTYgMTZoMzJjOC44IDAgMTYtNy4yIDE2LTE2VjgwYzAtOC44LTcuMi0xNi0xNi0xNnpNMTI4IDE3NmgtMTZ2LTk2aDE2OTZ6IiBmaWxsPSIjMDA1N2EzIi8+PC9zdmc+",
                        "sizes": "192x192",
                        "type": "image/svg+xml"
                    },
                    {
                        "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDI1NiAyNTYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTEyOCAwQzU3LjMgMCAwIDU3MyAwIDEyOHM1Ny4zIDEyOCAxMjggMTI4czEyOC01Ny4zIDEyOC0xMjhTMTk4LjcgMCAxMjggMHptMCAyNDBjLTYxLjggMC0xMTItNTAuMi0xMTItMTEyUzY2LjIgMTYgMTI4IDE2czExMiA1MC4yIDExMiAxMTItNTAuMiAxMTItMTEyIDExMnoiIGZpbGw9IiNmZmYiLz48cGF0aCBkPSJNMTQ0IDY0SDExMmMtOC44IDAtMTYgNy4yLTE2IDE2djk2YzAgOC44IDcuMiAxNiAxNiAxNmgzMmM4LjggMCAxNi03LjIgMTYtMTZWODBjMC04LjgtNy4yLTE2LTE2LTE2ek0xMjggMTc2aC0xNnYtOTZoMTY5NnoiIGZpbGw9IiMwMDU3YTMiLz48L3N2Zz4=",
                        "sizes": "512x512",
                        "type": "image/svg+xml"
                    }
                ]
            };
            
            const manifestLink = document.getElementById('appManifest');
            const blob = new Blob([JSON.stringify(manifest, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            manifestLink.href = url;
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        document.addEventListener('DOMContentLoaded', function() {
            // Generate manifest
            generateManifest();
            
            // Setup authentication
            setupAuthEventListeners();
            
            // Initialize authentication
            initializeAuth();
            
            // Initialize enhanced signup
            setupEnhancedSignup();
            
            // Setup app event listeners
            setupAppEventListeners();
            
            // Close summary modal
            document.getElementById('closeSummaryModal').addEventListener('click', () => {
                document.getElementById('summaryModal').style.display = 'none';
            });
        });
    </script>
</body>
</html>